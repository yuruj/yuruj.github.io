<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="">
    <meta name="keywords"  content="">
    <meta name="theme-color" content="#000000">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Python爬虫（2） - 余润杰的博客 | Yurj Blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="第四章 解析库的使用
">
    
    <meta property="article:published_time" content="2020-09-15T00:00:00Z">
    
    
    <meta property="article:author" content="yurj">
    
    
    <meta property="article:tag" content="爬虫">
    
    <meta property="article:tag" content="Python">
    
    <meta property="article:tag" content="学习笔记">
    
    
    <meta property="og:image" content="http://localhost:4000/img/ybmq.jpg">
    <meta property="og:url" content="http://localhost:4000/2020/09/15/Python3-%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-2/">
    <meta property="og:site_name" content="余润杰的博客 | Yurj Blog">
    
    <title>Python爬虫（2） - 余润杰的博客 | Yurj Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/2020/09/15/Python3-%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-2/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

<nav class="navbar navbar-default navbar-custom navbar-fixed-top invert">
    
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Yurj Blog</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="huxblog_navbar">
                <div class="navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="/">Home</a>
                        </li>
                        
                        
                        
                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                        
                        
                        <li>
                            <a href="/archive/">Archive</a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="search-icon">
                            <a href="javascript:void(0)">
                                <i class="fa fa-search"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <script>
        // Drop Bootstarp low-performance Navbar
        // Use customize navbar with high-quality material design animation
        // in high-perf jank-free CSS3 implementation
        var $body = document.body;
        var $toggle = document.querySelector('.navbar-toggle');
        var $navbar = document.querySelector('#huxblog_navbar');
        var $collapse = document.querySelector('.navbar-collapse');

        var __HuxNav__ = {
            close: function () {
                $navbar.className = " ";
                // wait until animation end.
                setTimeout(function () {
                    // prevent frequently toggle
                    if ($navbar.className.indexOf('in') < 0) {
                        $collapse.style.height = "0px"
                    }
                }, 400)
            },
            open: function () {
                $collapse.style.height = "auto"
                $navbar.className += " in";
            }
        }

        // Bind Event
        $toggle.addEventListener('click', function (e) {
            if ($navbar.className.indexOf('in') > 0) {
                __HuxNav__.close()
            } else {
                __HuxNav__.open()
            }
        })

        /**
         * Since Fastclick is used to delegate 'touchstart' globally
         * to hack 300ms delay in iOS by performing a fake 'click',
         * Using 'e.stopPropagation' to stop 'touchstart' event from 
         * $toggle/$collapse will break global delegation.
         * 
         * Instead, we use a 'e.target' filter to prevent handler
         * added to document close HuxNav.  
         *
         * Also, we use 'click' instead of 'touchstart' as compromise
         */
        document.addEventListener('click', function (e) {
            if (e.target == $toggle) return;
            if (e.target.className == 'icon-bar') return;
            __HuxNav__.close();
        })
    </script>
    <!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/timg.jpg" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/timg.jpg');
        background: ;
    }

    
</style>

<header class="intro-header style-text" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/archive/?tag=%E7%88%AC%E8%99%AB" title="爬虫">爬虫</a>
                        
                        <a class="tag" href="/archive/?tag=Python" title="Python">Python</a>
                        
                        <a class="tag" href="/archive/?tag=%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0" title="学习笔记">学习笔记</a>
                        
                    </div>
                    <h1>Python爬虫（2）</h1>
                    
                    <h2 class="subheading"></h2>
                    <span class="meta">Posted by yurj on September 15, 2020</span>
                </div>
            </div>
        </div>
    </div>
</header>






<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<h1 id="第四章-解析库的使用">第四章 解析库的使用</h1>

<h2 id="使用xpath">使用XPath</h2>

<p>P158</p>

<h2 id="使用beautiful-soup">使用Beautiful Soup</h2>

<p>P168</p>

<h2 id="使用pyquery">使用pyquery</h2>

<h3 id="初始化">初始化</h3>

<h4 id="字符串初始化">字符串初始化</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">doc</span><span class="p">(</span><span class="s">'li'</span><span class="p">))</span>

<span class="o">&lt;</span><span class="n">li</span> <span class="n">class</span><span class="o">=</span><span class="s">'...'</span><span class="o">&gt;</span><span class="p">....</span><span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">li</span> <span class="n">class</span><span class="o">=</span><span class="s">'...'</span><span class="o">&gt;</span><span class="p">....</span><span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">li</span> <span class="n">class</span><span class="o">=</span><span class="s">'...'</span><span class="o">&gt;</span><span class="p">....</span><span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="url初始化">URL初始化</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s">'.....'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">doc</span><span class="p">(</span><span class="s">'title'</span><span class="p">))</span>
<span class="c1">#这两者等价
</span><span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'.....'</span><span class="p">).</span><span class="n">text</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="文件初始化">文件初始化</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s">'demo.html'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">doc</span><span class="p">(</span><span class="s">'li'</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="基本css选择器">基本CSS选择器</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">doc</span><span class="p">(</span><span class="s">'#container .list li'</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">doc</span><span class="p">(</span><span class="s">'#container .list li'</span><span class="p">)))</span>

<span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">pyquery</span><span class="p">.</span><span class="n">pyquery</span><span class="p">.</span><span class="n">PyQuery</span><span class="s">'&gt;
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="查找节点">查找节点</h3>

<h4 id="字节点">字节点</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
<span class="n">items</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.list'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
<span class="n">lis</span> <span class="o">=</span> <span class="n">items</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'li'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">lis</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">lis</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>find方法的查找范围是节点的所有子孙节点，结果的类型是PyQuery类型</p>

<p>如果我们只想查找子节点，那么可以用children方法</p>

<h4 id="父节点">父节点</h4>

<p>我们可以用parent方法获取某个节点的父节点</p>

<p>如果想获取某个祖先节点，可以使用parents方法，也可以向该方法传入CSS选择器以筛选祖先节点</p>

<h4 id="兄弟节点">兄弟节点</h4>

<p>siblings方法</p>

<p>同样，可传入CSS选择器</p>

<h3 id="遍历">遍历</h3>

<p>pyquery的选择结果可能是多个节点，也可能是单个节点，类型都是PyQuery类型，并没有返回像Beautiful Soup那样的列表</p>

<p>对于单个节点，可以直接打印输出，也可以直接转成字符串</p>

<p>对于多个节点的结果，我们就需要遍历来获取了</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
<span class="n">lis</span><span class="p">.</span><span class="n">doc</span><span class="p">(</span><span class="s">'li'</span><span class="p">).</span><span class="n">items</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">lis</span><span class="p">))</span>
<span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">lis</span><span class="p">:</span>
  <span class="k">print</span><span class="p">(</span><span class="n">li</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">li</span><span class="p">))</span>
  
<span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">generator</span><span class="s">'&gt;
&lt;li class='</span><span class="n">item</span><span class="o">-</span><span class="mi">0</span><span class="s">'&gt;first item&lt;/li&gt;
&lt;class '</span><span class="n">pyquery</span><span class="p">.</span><span class="n">pyquery</span><span class="p">.</span><span class="n">PyQuery</span><span class="s">'&gt;
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>调用items方法后，会得到一个生成器，遍历一下，就可以逐个得到li节点对象了，它的类型也是PyQuery类型</p>

<p>每个li节点还可以调用前面所说的方法进行选择，比如继续查询字节点，非常灵活</p>

<h3 id="获取信息">获取信息</h3>

<h4 id="获取属性">获取属性</h4>

<p>提取到某个PyQuery类型的节点后，就可以调用attr方法来获取属性</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.item-0.active a'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">attr</span><span class="p">(</span><span class="s">'href'</span><span class="p">))</span>
<span class="c1">#这两者结果完全一样
#print(a.attr.href)
</span>
<span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">'link3.html'</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">'bold'</span><span class="o">&gt;</span><span class="n">third</span> <span class="n">item</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">pyquery</span><span class="p">.</span><span class="n">pyquery</span><span class="p">.</span><span class="n">PyQuery</span><span class="s">'&gt;
	link3.html
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>当返回结果是包含多个节点时，调用attr方法，只会得到第一个节点的属性</p>

<p>要想获取所有节点的属性，可以遍历</p>

<h4 id="获取文本">获取文本</h4>

<p>text方法可以获取其内部的文本信息，忽略掉节点内部包含的所有HTML，只返回纯文字内容</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.item-0.active a'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">text</span><span class="p">())</span>

<span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">'link3.html'</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">'bold'</span><span class="o">&gt;</span><span class="n">third</span> <span class="n">item</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="n">third</span> <span class="n">item</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>但如果想获取这个节点内部的HTML文本，就要用html方法</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
<span class="n">li</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.item-0.active'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">li</span><span class="p">.</span><span class="n">html</span><span class="p">())</span>

<span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">'link3.html'</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">'bold'</span><span class="o">&gt;</span><span class="n">third</span> <span class="n">item</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如果得到的结果是多个节点，并且想要获取每个节点的内部HTML文本，则需要遍历每个节点。而text方法不需要遍历就可以获得，它将所有节点取文本之后合并成一个字符串，中间用一个空格分隔开</p>

<h3 id="节点操作">节点操作</h3>

<h4 id="addclass和removeclass">addClass和removeClass</h4>

<p>动态改变节点的class属性</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
<span class="n">li</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.item-a.active'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">li</span><span class="p">)</span>
<span class="n">li</span><span class="p">.</span><span class="n">removeClass</span><span class="p">(</span><span class="s">'active'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">li</span><span class="p">)</span>
<span class="n">li</span><span class="p">.</span><span class="n">addClass</span><span class="p">(</span><span class="s">'active'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">li</span><span class="p">)</span>

<span class="o">&lt;</span><span class="n">li</span> <span class="n">class</span><span class="o">=</span><span class="s">'item-0 active'</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">'link3.html'</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">'bold'</span><span class="o">&gt;</span><span class="n">third</span> <span class="n">item</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">li</span> <span class="n">class</span><span class="o">=</span><span class="s">'item-0'</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">'link3.html'</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">'bold'</span><span class="o">&gt;</span><span class="n">third</span> <span class="n">item</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">li</span> <span class="n">class</span><span class="o">=</span><span class="s">'item-0 active'</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">'link3.html'</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">'bold'</span><span class="o">&gt;</span><span class="n">third</span> <span class="n">item</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="atttext和html">att、text和html</h4>

<p>如果attr方法只传入第一个参数的属性名，则是获取这个属性值，如果传入第二个参数，可以用来修改属性值</p>

<p>text和html方法如果不传参数，则是获取节点内的纯文本和HTML文本，如果传入参数，则进行赋值</p>

<h4 id="remove">remove()</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
<span class="n">wrap</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.wrap'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">wrap</span><span class="p">.</span><span class="n">text</span><span class="p">())</span>
<span class="n">wrap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'p'</span><span class="p">).</span><span class="n">remove</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">wrap</span><span class="p">.</span><span class="n">text</span><span class="p">())</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="伪类选择器">伪类选择器</h3>

<p>CSS选择器之所以强大，还有一个很重要的原因，那就是它支持各种各样的伪类选择器，例如选择第一个节点、最后一个节点、奇偶数节点、包含某一文本的节点等</p>

<h1 id="第五章数据存储">第五章数据存储</h1>

<h2 id="文件存储">文件存储</h2>

<h3 id="txt文本存储">TXT文本存储</h3>

<p>将数据保存到TXT文本的操作非常简单，而且TXT文本几乎兼容任何平台，但是不利于检索</p>

<p>如果对检索和数据结构要求不高，追求方便第一的话，可以采用TXT文本存储</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">query</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>

<span class="n">url</span> <span class="o">=</span> <span class="s">'https://www.zhihu.com/explore'</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s">'User-Agent'</span><span class="p">:</span> <span class="s">'....'</span>
<span class="p">}</span>
<span class="n">html</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="p">).</span><span class="n">text</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
<span class="n">items</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">'.explore-tab .feed-item'</span><span class="p">).</span><span class="n">item</span><span class="p">()</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
  <span class="n">question</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'h2'</span><span class="p">).</span><span class="n">text</span><span class="p">()</span>
  <span class="n">author</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'.author-link-line'</span><span class="p">).</span><span class="n">text</span><span class="p">()</span>
  <span class="n">answer</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'.content'</span><span class="p">).</span><span class="n">html</span><span class="p">()).</span><span class="n">text</span><span class="p">()</span>
  <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'explore.txt'</span><span class="p">,</span> <span class="s">'a'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">)</span>
  <span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">question</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="n">answer</span><span class="p">]))</span>
  <span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span> <span class="o">+</span> <span class="s">'='</span> <span class="o">*</span> <span class="mi">50</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
  <span class="nb">file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这样热门回答的内容就被保存成文本形式</p>

<p>open方法的第一个参数即要保存的目标文件名称，第二个参数为a，代表以追加方式写入到文本。另外，我们还指定了文件的编码为utf-8。最后，写入完成后，还需要调用close方法来关闭文件对象</p>

<h4 id="打开方式">打开方式</h4>

<p>r：只读，默认模式，文件的指针将会放在文件的开头</p>

<p>rb：以二进制只读方式打开一个文件，文件的指针将会放在文件的开头</p>

<p>r+：以读写方式打开一个文件，文件的指针将会放在文件的开头</p>

<p>rb+：以二进制读写方式打开一个文件，文件的指针将会放在文件的开头</p>

<p>w：以写入方式打开一个文件。如果该文件已存在，则将其覆盖。如果该文件不存在，则创建新文件</p>

<p>wb：以二进制写入方式打开一个文件。如果该文件已存在，则将其覆盖。如果该文件不存在，则创建新文件</p>

<p>w+：以读写方式打开一个文件。如果该文件已存在，则将其覆盖。如果该文件不存在，则创建新文件</p>

<p>wb+：以二进制读写格式打开一个文件。如果该文件已存在，则将其覆盖。如果该文件不存在，则创建新文件</p>

<p>a：以追加方式打开一个文件。如果该文件已存在，文件指针将会被放在文件结尾。如果该文件不存在，则创建新文件来写入</p>

<p>ab：以二进制追加方式打开一个文件。如果该文件已存在，文件指针将会被放在文件结尾。如果该文件不存在，则创建新文件来写入</p>

<p>a+：以读写方式打开一个文件。如果该文件已存在，文件指针将会被放在文件结尾。如果该文件不存在，则创建新文件来读写</p>

<p>ab+：以二进制追加方式打开一个文件。如果该文件已存在，文件指针将会被放在文件结尾。如果该文件不存在，则创建新文件来读写</p>

<h4 id="简化写法">简化写法</h4>

<p>with as语法，在with控制块结束时，文件会自动关闭，所以就不需要再调用close方法</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'explore.txt'</span><span class="p">,</span> <span class="s">'a'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
  <span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">question</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="n">answer</span><span class="p">]))</span>
  <span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span> <span class="o">+</span> <span class="s">'='</span> <span class="o">*</span> <span class="mi">50</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这种方法简单易用，操作高效，是一种最基本保存数据的方法</p>

<h3 id="json文件存储">JSON文件存储</h3>

<p>JSON，全程为JavaScript Object Notation，也就是JS对象标记，它通过对象和数组的组合来表示数据，构造简单但结构化程度非常高，是一种轻量级的数据交换格式</p>

<h4 id="对象和数组">对象和数组</h4>

<p>在JS语言中，一切都是对象。因此，任何支持的类型都可以通过JSON来表示，例如字符串、数字、对象、数组等，但是对象和数组是比较特殊且常用的两种类型</p>

<p>对象：</p>

<p>它在JS中时使用花括号{}包裹起来的内容，数据结构为{key1: value1, key2: value2, …}的键值对结构。在面向对象的语言中，key为对象的属性，value为对应的值。键名可以用整数和字符串来表示，值的类型可以是任意类型</p>

<p>数组：</p>

<p>数组在JS中是方括号[]包裹起来的内容，数据结构为[‘java’, ‘js’, …]的索引结构，在JS中，数组是一种比较特殊的数据结构，它可以像对象那样使用键值对，但还是索引用的多。同样，值的类型可以是任意类型</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="p">[{</span>
    <span class="s">"name"</span><span class="p">:</span> <span class="s">"Bob"</span><span class="p">,</span>
    <span class="s">"gender"</span><span class="p">:</span> <span class="s">"male"</span>
<span class="p">},{</span>
    <span class="s">"name"</span><span class="p">:</span> <span class="s">"Selina"</span><span class="p">,</span>
  	<span class="s">"gender"</span><span class="p">:</span> <span class="s">"female"</span><span class="p">,</span>
<span class="p">}]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>有中括号包围的就相当于列表类型，列表中的每个元素可以是任意类型，这个示例中它是字典类型，由大括号包围</p>

<p>JSON可以由以上两种形式自由组合而成，可以无限次嵌套，结构清晰，是数据交换的极佳方式</p>

<h4 id="读取json">读取JSON</h4>

<p>调用JSON库的loads方法将JSON文本字符串转为JSON对象，可以通过dumps方法将JSON对象转为文本字符串</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">json</span>

<span class="nb">str</span> <span class="o">=</span> <span class="s">'''
....
'''</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">str</span><span class="s">'&gt;
.....
&lt;class '</span><span class="nb">list</span><span class="s">'&gt;
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>由于最外层是中括号，所以最终的类型是列表类型</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">'name'</span><span class="p">]</span>
<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="s">'name'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>推荐使用get方法，因为此时如果键名不存在，则不会报错，返回None，另外，get方法可以传入第二个参数即默认值，在不存在的情况下不返回None，返回默认值</p>

<p>JSON的数据需要用双引号包围，而不能用单引号,否则会解析失败</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">json</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'data.json'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
  <span class="nb">str</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="输出json">输出JSON</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="n">improt</span> <span class="n">json</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">[{</span>
  <span class="s">'name'</span><span class="p">:</span> <span class="s">'Bob'</span><span class="p">,</span>
  <span class="s">'gender'</span><span class="p">:</span> <span class="s">'male'</span>
<span class="p">}]</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'data.json'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
  <span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>另外，想保存JSON格式，可以再加一个参数indent，代表缩进字符个数</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'data.json'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
  <span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这样得到的内容会自动带缩进，格式更加清晰</p>

<p>若想输出的JSON中包含中文字符，而不是将值输出后变成Unicode码</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'data.json'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
  <span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="csv文件存储">CSV文件存储</h3>

<p>CSV，全程为Comma-Seperated Values，中文可以叫做逗号分隔值或字符分隔值，其文件以纯文本形式存储表格数据</p>

<p>比Excel文件更加简洁，XLS文本是电子表格，它包含了文本、数值、公式和格式等内容，而CSV中不包含这些内容，就是特定字符分隔的纯文本，结构简单清晰</p>

<p>该文件是一个字符序列，可以由任意树木的记录组成，记录间以某种换行符分隔。每条记录由字段组成，字段间的分隔符是其他字符或字符串，最常见的是逗号或制表符。</p>

<p>所有记录都有完全相同的字段序列，相当于一个结构化表的纯文本形式</p>

<h4 id="写入">写入</h4>

<p>P204</p>

<h4 id="读取">读取</h4>

<p>P206</p>

<h2 id="关系型数据库存储">关系型数据库存储</h2>

<p>关系型数据库是基于关系模型的数据库，而关系模型是通过二维表来存储的。所以它的存储方式就是行列组成的表。</p>

<p>表可以看作某个实体的集合，而实体之间存在联系，这就需要表与表之间的关联体系来体现。多个表组成一个数据库，也就是关系型数据库。</p>

<p>P207</p>

<h2 id="非关系型数据库存储">非关系型数据库存储</h2>

<p>NoSQL，not only SQL</p>

<p>基于键值对，不需要经过SQL层的解析，数据之间没有耦合，性能非常高</p>

<p>键值存储数据库 列存储数据库 文档型数据库 图形数据库</p>

<p>对于爬虫的数据存储来说，一条数据可能存在某些字段提取失败而缺失的情况，而且数据可能随时调整。另外，数据之间可能还存在数据嵌套关系。如果使用关系型数据库，一是需要提前建表，二是如果存在数据嵌套关系的话，需要进行序列化操作才可以存储，这非常不方便。如果使用了非关系型数据库，就可以避免一些麻烦，更简单高效</p>

<p>P213</p>

<h1 id="第六章-ajax数据爬取">第六章 Ajax数据爬取</h1>

<p>有时候我们在用requests抓取页面的时候，得到的结果可能和浏览器中看到的不一样：在浏览器中可以看到正常的页面数据，但是使用requests得到的结果并没有，这是因为requests获取的都是原始的HTML文档，而浏览器中的页面则是经过JS处理数据后生成的结果，这些数据的来源有多种，可能是通过Ajax加载的，可能是包含在HTML文档，也可能是经过JS和特定算法计算后生成的</p>

<p>对于对一种情形，数据加载是一种异步加载方式。原始的页面最初不会包含某些数据，原始页面加载完后，会再向服务器请求某个接口获取数据，然后数据才会被处理从而呈现到网页上，这其实就是发送了一个Ajax请求</p>

<p>照Web发展的趋势来看，这种形式的页面越来越多。网页的原始HTML文档不会包含任何数据，数据都是通过Ajax统一加载后再呈现出来的，这样在Web开发上可以实现前后端分离，而且降低服务器直接渲染页面带来的压力</p>

<p>所以如果遇到这样的页面，直接利用requests等库来抓取原始页面，是无法获取到有效数据的，这时需要分析网页后台向接口发送的Ajax请求，如果可以用requests来模拟Ajax请求，那么就可以成功抓去了</p>

<h2 id="什么是ajax">什么是Ajax</h2>

<p>Asynchronous JavaScript XML 即异步的XML</p>

<p>它不是一门编程语言，而是利用JavaScript在保证页面不被刷新、页面链接不改变的情况下与服务器交换数据并更新部分网页的技术</p>

<p>对于传统的网页，如果想更新其内容，那么就必须要刷新整个页面，但有了Ajax，便可以在页面不被全部刷新的情况下更新其内容。在这个过程中，页面实际上是在后台与服务器进行了数据交互，获取到数据之后，再利用JS改变网页，这样网页内容就会更新了</p>

<h3 id="实例引入">实例引入</h3>

<p>很多网页下滑查看更多，出现一个加载动画，这其实就是Ajax加载的过程</p>

<h3 id="基本原理">基本原理</h3>

<p>JS向服务器发送了一个Ajax请求，然后获取新数据，将其解析，并将其渲染在网页中</p>

<h2 id="ajax分析方法">Ajax分析方法</h2>

<h3 id="查看请求">查看请求</h3>

<p>Network组件</p>

<p>Ajax有其特殊的请求类型，叫做xhr</p>

<p>点击preview，即可看到响应的内容，它是JSON格式的。这里Chrome为我们自动做了解析</p>

<p>另外，也可以切换到Response选项卡，从中观察到真实的返回数据</p>

<h3 id="过滤请求">过滤请求</h3>

<p>在请求的上方有一层筛选栏，直接点击XHR，此时在下方显示的所有请求便都是Ajax请求了</p>

<h2 id="ajax结果提取">Ajax结果提取</h2>

<h3 id="分析请求">分析请求</h3>

<p>以微博为例，可以发现，这一个GET类型的请求，请求连接有4个参数：type，value，containerid，page</p>

<p>type始终为uid，value的值就是页面链接中的数字，其实这就是用户的id。另外，还有containerid。可以发现，他就是107603加上用户id。改变的值就是page，很明显这个参数是用来控制分页的，page=1代表第一页</p>

<h3 id="分析响应">分析响应</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlencode</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="n">base_url</span> <span class="o">=</span> <span class="s">'https://m.weibo.cn/api/container/getIndex?'</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s">'Host'</span><span class="p">:</span> <span class="s">'m.weibo.cn'</span><span class="p">,</span>
  <span class="s">'Referer'</span><span class="p">:</span> <span class="s">'https://m.weibo.cn/u/2830678474'</span><span class="p">,</span>
  <span class="s">'User-Agent'</span><span class="p">:</span> <span class="s">'....'</span><span class="p">,</span>
  <span class="s">'X-Requested-With'</span><span class="p">:</span> <span class="s">'XMLHttpRequest'</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">get_page</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
  <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'type'</span><span class="p">:</span> <span class="s">'uid'</span><span class="p">,</span>
    <span class="s">'value'</span><span class="p">:</span> <span class="s">'...'</span><span class="p">,</span>
    <span class="s">'containerid'</span><span class="p">:</span> <span class="s">'....'</span>
    <span class="s">'page'</span><span class="p">:</span> <span class="n">page</span>
  <span class="p">}</span>
  <span class="n">url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="o">+</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
      <span class="n">retuen</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
	<span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Error'</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>

<span class="k">def</span> <span class="nf">parse_page</span><span class="p">(</span><span class="n">json</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">json</span><span class="p">:</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'data'</span><span class="p">).</span><span class="n">get</span><span class="p">(</span><span class="s">'cards'</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'mblog'</span><span class="p">)</span>
        <span class="n">weibo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">weibo</span><span class="p">[</span><span class="s">'id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'id'</span><span class="p">)</span>
        <span class="n">weibo</span><span class="p">[</span><span class="s">'text'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'text'</span><span class="p">).</span><span class="n">text</span><span class="p">())</span>
        <span class="n">weibo</span><span class="p">[</span><span class="s">'attitudes'</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'attitudes_count'</span><span class="p">)</span>
        <span class="n">weibo</span><span class="p">[</span><span class="s">'comments'</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'comments_count'</span><span class="p">)</span>
        <span class="n">weibo</span><span class="p">[</span><span class="s">'reposts'</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'reposts_count'</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">weibo</span>

<span class="k">if</span> <span class="n">_name_</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
  <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">11</span><span class="p">):</span>
    <span class="n">json</span> <span class="o">=</span> <span class="n">get_page</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">parse_page</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
      <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
      
<span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">()</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="s">'weibo'</span><span class="p">]</span>
<span class="n">collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s">'weibo'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">save_to_mongo</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">collection</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">reuslt</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Save to Mongo'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="分析ajax爬取今日头条街拍美图">分析Ajax爬取今日头条街拍美图</h2>

<p>P242</p>

<p>图片的名称可以使用其内容的MD5值，去除重复</p>

<h1 id="第七章-动态页面爬取">第七章 动态页面爬取</h1>

<p>Ajax其实是JS动态渲染页面的一种情形。不过JS动态渲染的页面不止是Ajax这一种。即使是Ajax获取的数据，但其接口含有很多加密参数，我们难以直接找出其规律，也很难直接分析Ajax来抓取</p>

<p>为了解决这些问题，我们可以直接使用模拟浏览器运行的方式来实现，这样就可以做到在浏览器中看到是什么样的，抓取的源码就是什么样的，也就是可见可爬。这样我们就不用再去管网页内部的JS用了什么算法渲染页面，也不用管网页后台的Ajax接口到底有哪些参数</p>

<h2 id="selenium的使用">Selenium的使用</h2>

<p>Selenium是一个自动化测试工具，利用它可以驱动浏览器执行特定的动作，如点击、下拉等操作，同时还可以获取浏览器当前呈现的页面的源代码，做到可见即可爬。对于一些JavaScript动态渲染的页面来说，此种抓取方式非常有效。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.by</span> <span class="kn">import</span> <span class="n">By</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.comman.keys</span> <span class="kn">import</span> <span class="n">Keys</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.support</span> <span class="kn">import</span> <span class="n">expected_conditions</span> <span class="k">as</span> <span class="n">EC</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.support.wait</span> <span class="kn">import</span> <span class="n">WebDriverWait</span>

<span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">Chrome</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
	<span class="n">browser</span><span class="p">.</span><span class="n">get</span> <span class="p">(</span><span class="s">'https://www.baidu.com'</span><span class="p">)</span>
	<span class="nb">input</span> <span class="o">=</span> <span class="n">browser</span><span class="p">.</span><span class="n">find_element_by_id</span> <span class="p">(</span><span class="s">'kw'</span><span class="p">)</span>
	<span class="nb">input</span><span class="p">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s">'Python'</span><span class="p">)</span>
	<span class="nb">input</span><span class="p">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="p">.</span><span class="n">ENTER</span><span class="p">)</span>
	<span class="n">wait</span> <span class="o">=</span> <span class="n">WebDriverWait</span><span class="p">(</span><span class="n">browser</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
	<span class="n">wait</span><span class="p">.</span><span class="n">until</span><span class="p">(</span><span class="n">EC</span><span class="p">.</span><span class="n">presence_of_element_located</span><span class="p">((</span><span class="n">By</span><span class="p">.</span><span class="n">ID</span><span class="p">,</span><span class="s">'content left'</span><span class="p">)))</span> 			
  <span class="k">print</span><span class="p">(</span><span class="n">browser</span><span class="p">.</span><span class="n">current_url</span><span class="p">)</span>
	<span class="k">print</span><span class="p">(</span><span class="n">browser</span><span class="p">.</span><span class="n">get_cookies</span><span class="p">())</span>
	<span class="k">print</span><span class="p">(</span><span class="n">browser</span><span class="p">.</span><span class="n">page_source</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
	<span class="n">browser</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>运行代码后发现，会自动弹出一个Chrome浏览器。浏览器首先会跳转到百度，然后在搜索框中输入Python，接着跳转到搜索结果页。搜索结果加载出来后，控制台分别会输出当前的URL、当前的Cookies和网页源代码</p>

<p>用Selenium来驱动浏览器加载网页的话，就可以直接拿到JS渲染的结果了，不用担心使用的是什么加密系统</p>

<h3 id="声明浏览器对象">声明浏览器对象</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>

<span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">Chrome</span><span class="p">()</span>
<span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">Firefox</span><span class="p">()</span>
<span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">Edge</span><span class="p">()</span>
<span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">PhantomJS</span><span class="p">()</span>
<span class="n">browser</span><span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">Safari</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="访问页面">访问页面</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdnver</span>
<span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">Chrome</span><span class="p">()</span>
<span class="n">browser</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://www.taobao.com'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">browser</span><span class="p">.</span><span class="n">page_source</span><span class="p">)</span>
<span class="n">browser</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>我们可以用get方法来请求网页，参数传入链接URL即可</p>

<h3 id="查找节点-1">查找节点</h3>

<p>Selenium可以驱动浏览器完成各种操作，比如填充表格、模拟点击等。</p>

<h4 id="单个节点">单个节点</h4>

<p>P251</p>

<p>返回的是WebElement类型</p>

<h4 id="多个节点">多个节点</h4>

<p>P253</p>

<p>返回的是WebElement类型</p>

<h3 id="节点交互">节点交互</h3>

<p>Selenium可以驱动浏览器来执行一些操作，也就是说可以让浏览器模拟执行一些动作。</p>

<p>比较常见的用法是：输入文字时用send_keys方法，清空文字时用clear方法，点击按钮时用click方法</p>

<h3 id="动作链">动作链</h3>

<p>在上面的实例中，一些交互动作都是针对某个节点执行的。另外还有一些动作，他们没有特定的执行对象，比如鼠标拖曳、键盘按键等，这些动作用另一种方式来执行，那就是动作链</p>

<h3 id="执行javascript">执行JavaScript</h3>

<p>对于某些操作，Selenium API并没有提供。比如，下拉进度条，它可以直接模拟运行JavaScript，此时可以使用execute_script方法即可实现</p>

<p>有了这个方法，基本上API没有提供的所有功能都可以用执行JavaScript的方式来实现了</p>

<h3 id="获取节点信息">获取节点信息</h3>

<p>通过page_source属性可以获取网页的源代码，接着就可以使用解析库来提取信息了</p>

<p>不过，既然Selenium已经提供了选择节点的方法，返回的是WebElement类型，那么他也有相关的方法和属性来直接提取节点信息，这样的话，我们就可以不用通过解析源代码来提取信息，非常方便</p>

<h4 id="获取属性-1">获取属性</h4>

<p>get_attribute放啊放</p>

<h4 id="获取文本值">获取文本值</h4>

<p>每个WebElement节点都有text属性，直接调用这个属性就可以得到节点内部的文本信息</p>

<h3 id="获取id位置标签名和大小">获取id、位置、标签名和大小</h3>

<p>WebElement节点还有其他属性，比如id属性可以获取节点id，location属性可以获取该节点在页面中的相对位置，tag_name属性可以获取标签名称，Size属性可以获取节点的大小，也就是宽高</p>

<h3 id="切换frame">切换Frame</h3>

<p>网页中有一种节点叫做iframe，也就是子Frame，相当于页面中的子页面，它的结构和外部网页结构完全一致。Selenium打卡网页后，它默认是在父级Frame里面操作，而此时如果页面中还有子Frame，它是不能获取到子Frame里面的节点的。这时就需要使用switch_to.frame方法来切换Frame</p>

<h3 id="延时等待">延时等待</h3>

<p>在Selenium中，get方法会在网页框架加载结束后结束执行，此时如果获取page_sorce,可能并不是浏览器完全加载完成的页面，如果某些页面有额外的Ajax请求，我们在网页源代码中也不一定能成功获取到。所以，这里需要延时等待一定时间，确保节点已经加载出来</p>

<h4 id="隐式等待">隐式等待</h4>

<p>当使用隐式等待执行测试的时候，如果Selenium没有在DOM中找到节点，将继续等待，超过设定时间后，则抛出找不到节点的异常。换句话说，当查找节点而节点并没有立即出现的时候，隐式等待将等待一段时间后再查找DOM，默认的时间是0</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">bowser</span><span class="p">.</span><span class="n">implicitly_wait</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="显式等待">显式等待</h4>

<p>隐式等待的效果其实并没有那么好，因为我们只规定了一个固定时间，而页面的加载时间会受到网络条件的影响。这里还有一种更合适的显式等待方法，它指定要查找的节点；如果到了规定时间依然没有加载出该节点，则抛出超时异常</p>

<p>P258</p>

<h3 id="前进和后退">前进和后退</h3>

<p>平常使用浏览器都有前进和后退功能，Selenium也可以完成这个操作，它使用back方法后退，使用forward方法前进</p>

<h3 id="cookies">Cookies</h3>

<p>使用Selenium，还可以方便地对Cookies进行操作，例如获取、添加、删除Cookies等</p>

<h3 id="选项卡管理">选项卡管理</h3>

<p>P261</p>

<h3 id="异常处理">异常处理</h3>

<p>P261</p>

<h2 id="splash的使用">Splash的使用</h2>

<p>P262</p>

<h2 id="spalsh负载均衡配置">Spalsh负载均衡配置</h2>

<p>P286</p>

<h2 id="使用selenium爬取淘宝商品">使用Selenium爬取淘宝商品</h2>

<p>可看即可爬</p>

<p>在开始之前，请确保已经正确安装好Chrome浏览器并配置好了ChromeDriver；另外，还需正确安装Python的Selenium库；最后，还对接了PhantomJS和Firefox，请确保安装好了PhantomJS和Firefox并配置好了GeckoDriver</p>

<h3 id="chrome-headless模式">Chrome Headless模式</h3>

<p>从Chrome59版本开始，已经开始支持Headless模式，也就是无界面模式，这样爬取的时候就不会弹出浏览器了</p>

<p>启用Headless模式的方式如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">chrome_options</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">ChromeOptions</span><span class="p">()</span>
<span class="n">chrome_options</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'--headless'</span><span class="p">)</span>
<span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">Chrome</span><span class="p">(</span><span class="n">chrome_options</span><span class="o">=</span><span class="n">chrome_options</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>首先，创建ChromeOptions对象是，接着添加headless参数，然后在初始化Chrome对象的时候通过chrome_options传递这个ChromeOptions对象，这样我们就可以成功呢启用Chrome的Headless模式了</p>

<h3 id="对接firefox">对接Firefox</h3>

<p>只需</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">Firefox</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="对接phantomjs">对接PhantomJS</h3>

<p>PhatomJS是一个无界面浏览器</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">PhantomJS</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>另外，它还支持命令行配置。比如，可以设置缓存和禁用图片加载的功能，进一步提高爬取效率</p>

<h1 id="第八章-验证码的识别">第八章 验证码的识别</h1>

<h2 id="图形验证码的识别">图形验证码的识别</h2>

<p>P298</p>

<h2 id="极验滑动验证码的识别">极验滑动验证码的识别</h2>

<p>P301</p>

<h2 id="点触验证码的识别">点触验证码的识别</h2>

<p>P311</p>

<h2 id="微博宫格验证码的识别">微博宫格验证码的识别</h2>

<p>P318</p>

<h1 id="第九章-代理的使用">第九章 代理的使用</h1>

<p>127.0.0.1</p>

<p>127.0.0.1:1087</p>

<h2 id="代理的设置">代理的设置</h2>

<p>免费代理大多数情况下都是不好用的，所以比较靠谱的方法是购买付费代理</p>

<p>如果本纪有相关代理软件的话，软件一般会在本机创建HTTP或SOCKS代理服务，本机直接使用此代理也可以</p>

<h3 id="urllib">urllib</h3>

<p>P327</p>

<p>当请求的链接是http协议的时候，ProxyHandler会调用http代理，当请求的链接是https协议的时候，会调用https代理</p>

<p>如果遇到需要认证的代理，只需在代理前面加入代理认证的用户名密码即可。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">username</span><span class="p">:</span><span class="n">password</span><span class="o">@</span><span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">1087</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如果代理是Socks5类型，可以用如下方式设置代理</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">socks</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">URLError</span>

<span class="n">socks</span><span class="p">.</span><span class="n">set_default_proxy</span><span class="p">(</span><span class="n">socks</span><span class="p">.</span><span class="n">SOCKSS</span><span class="p">,</span><span class="err">’</span><span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="err">’</span><span class="p">,</span> <span class="mi">9742</span><span class="p">)</span>
<span class="n">socket</span><span class="p">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socks</span><span class="p">.</span><span class="n">socksocket</span>
<span class="k">try</span><span class="p">:</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">urlopen</span><span class="p">(</span><span class="err">’</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">httpbin</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">get</span><span class="err">’</span><span class="p">)</span>
	<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
<span class="k">except</span> <span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
	<span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">reason</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="requests">requests</h3>

<p>对于requests来说，代理设置更加简单，我们只需要传入proxies参数即可</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">proxy</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s">'http'</span><span class="p">:</span> <span class="s">''</span><span class="p">,</span>
  <span class="s">'https'</span><span class="p">:</span> <span class="s">''</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">try</span><span class="p">:</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">''</span><span class="p">,</span><span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
  <span class="k">print</span><span class="p">(</span><span class="s">'Error'</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>

<span class="c1">#SOCKS5代理(1) 需pip3 install 'requests[socks]'
</span><span class="kn">import</span> <span class="nn">requests</span>
<span class="n">proxy</span> <span class="o">=</span> 
<span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s">'http'</span><span class="p">:</span> <span class="s">'socks5://'</span> <span class="o">+</span> <span class="n">proxy</span>
  <span class="s">'https'</span><span class="p">:</span> <span class="s">'socks5://'</span> <span class="o">+</span> <span class="n">proxy</span>
<span class="p">}</span>
<span class="k">try</span><span class="p">:</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">''</span><span class="p">,</span><span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
  <span class="k">print</span><span class="p">(</span><span class="s">'Error'</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
  
<span class="c1">#SOCKS5代理(2) 此方法是全局设置
</span><span class="kn">import</span> <span class="nn">socks</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">socks</span><span class="p">.</span><span class="n">set_default_proxy</span><span class="p">(</span><span class="n">socks</span><span class="p">.</span><span class="n">SOCKSS</span><span class="p">,</span><span class="err">’</span><span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="err">’</span><span class="p">,</span> <span class="mi">9742</span><span class="p">)</span>
<span class="n">socket</span><span class="p">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socks</span><span class="p">.</span><span class="n">socksocket</span>
<span class="k">try</span><span class="p">:</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">''</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
  <span class="k">print</span><span class="p">(</span><span class="s">'Error'</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">args</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="selenium">Selenium</h3>

<h4 id="chrome">Chrome</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>

<span class="n">proxy</span><span class="o">=</span> <span class="s">'127.0.0.1:9743'</span>
<span class="n">chrome_options</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">ChromeOptions</span><span class="p">()</span>
<span class="n">chrome_options</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'--proxy-server=http://'</span> <span class="o">+</span> <span class="n">proxy</span><span class="p">)</span>
<span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">Chrome</span><span class="p">(</span><span class="n">chrome_options</span><span class="o">=</span><span class="n">chrome_options</span><span class="p">)</span>
<span class="n">browser</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://httpbin.org/get'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如果代理是认证代理，则设置方法相对比较麻烦，这需要在本地创建一个manifest.json配置文件和background.js脚本来设置认证代理。运行代码后本地会生成一个proxy_auth_plugin.zip文件来保存当前配置</p>

<p>P331</p>

<h4 id="phantomjs">PhantomJS</h4>

<p>P332</p>

<h2 id="代理池的维护">代理池的维护</h2>

<h3 id="准备工作">准备工作</h3>

<p>首先要成功安装Redis数据库并启动服务，另外还需安装aiohttp、requests、redis-py、pyquery、Flask库</p>

<h3 id="代理池的目标">代理池的目标</h3>

<p>基本模块：存储模块 获取模块 检测模块 接口模块 调度模块</p>

<p>Web API</p>

<p>P335</p>

<h2 id="付费代理的使用">付费代理的使用</h2>

<p>付费代理分为两类：
一类提供接口获取海量代理，按天或者按量收费，如讯代理</p>

<p>一类搭建了代理隧道，直接设置固定域名代理，如阿布云代理</p>

<p>P347</p>

<h2 id="adsl拨号代理">ADSL拨号代理</h2>

<p>代理池可以挑选出许多可用代理，但是常常其稳定性不高、响应速度慢，而且这些代理通常是公共代理，IP被封的概率很大。另外，这些代理可能有效时间比较短，虽然代理池一直在筛选，但如果没有及时更新状态，也有可能获取到不可用的代理</p>

<p>通过ASDL拨号代理，我们可以无限次更换IP，而且线路非常稳定，抓取效果好很多</p>

<p>P351</p>

<h2 id="使用代理爬取微信公众号文章">使用代理爬取微信公众号文章</h2>

<p>如果服务器返回状态码为302而非200，就是IP访问次数太高，IP被封禁</p>

<p>实现请求的数据结构，构造队列</p>

<p>P364</p>

<h1 id="第十章-模拟登陆">第十章 模拟登陆</h1>

<h2 id="模拟登陆并爬取github">模拟登陆并爬取Github</h2>

<h3 id="分析登陆过程">分析登陆过程</h3>

<p>打开开发者工具，将Preserve Log选项勾上，这表示显示持续日志</p>

<p>点击sessin请求，可以看到请求的页面是https://github.com/session，请求方式为POST</p>

<p>Form Data包含了5个字段，commit是固定的字符串Sign in，utf-8是一个勾选字符，authenticity_token较长，初步判断是一个Base64加密的字符串，login是登陆的用户名，password是登陆的密码</p>

<p>综上所述，我们现在无法直接构造的内容有Cookies和authenticity_token</p>

<p>在登陆之前我们会访问到一个登陆页面，此页面是通过GET形式访问的。输入用户名密码，点击登录按钮，浏览器发送这两部分信息，也就是说Cookies和authenticity_token一定是在访问登陆页的时候设置的</p>

<p>这是再退出登录，回到登陆页，同时清空Cookies，重新访问登陆页，截获发生的请求。Response Headers上有一个Set-Cookie字段。这就是设置Cookies的过程</p>

<p>另外，我们发现Response Headers没有和authenticity_token相关的信息，所以可能authenticity_token还隐藏在其他的页面或者是计算出来的</p>

<p>我们再从网页的源码探寻，搜索相关字段，发现源代码里面还隐藏着此信息，它是一个隐藏式表单元素</p>

<h2 id="cookies池的搭建">Cookies池的搭建</h2>

<p>很多时候，在爬取没有登陆的情况下，我们也可以访问一部分页面或请求一些接口，因为毕竟网站本身需要做SEO，不会对所有页面都设置登陆限制</p>

<p>但是，不登陆直接爬取会有一些弊端，弊端主要有以下两点：</p>

<p>设置了登陆限制的页面无法爬取</p>

<p>一些页面或接口虽然可以直接请求，但是请求一旦频繁，访问就容易被限制或者IP直接被封，但是登陆以后就不会出现这样的问题，因此登陆之后被反爬的可能性更低</p>

<p>登陆账号可以降低被封禁的概率</p>

<p>我们可以尝试登陆以后再做爬取，被封禁的几率会小很多</p>

<p>如果需要做大规模抓取，我们就需要拥有很多账号，每次请求随机选取一个账号，这样就降低了单个账号的访问频率，被封的概率又会大大降低</p>

<p>维护多个账号的登陆信息就需要用到Cookies池</p>

<p>自动生成Cookies、定时监测Cookies、提供随机Cookies</p>

<p>存储模块 获取模块 检测模块 接口模块 调度模块</p>

<p>P385</p>

<h1 id="第十一章-app的爬取">第十一章 App的爬取</h1>

<p>App的爬取相比Web端爬取更加容易，反爬虫能力没有那么强，而且数据大多是以JSON形式传输的，解析更加简单</p>

<p>在Web端，我们可以通过浏览器的开发者工具监听到各个网络请求和响应过程，在App端如果想要查看这些内容就需要借助抓包软件</p>

<p>我们可以通过设置代理的方式将手机处于抓包软件的监听之下，这样便可以看到App在运行过程中发生的所有请求和响应了，相当于分析Ajax一样。如果这些请求的URL、参数等都是有规律的，那么总结出规律直接用程序模拟爬取即可，如果他们没有规律，我们可以利用另一个工具mitmdump对接Python脚本直接处理Response。另外，App的爬取肯定不能由人来完成，也需要做到自动化，所以我们还要对App进行自动化控制，这里利用到的库是Appium</p>

<h2 id="charles的使用">Charles的使用</h2>

<p>Charles是一个网络抓包工具，我们可以用它来做App的抓包分析，得到App运行过程中发生的所有网络请求和响应内容，这就和Web端浏览器的开发者工具Network部分看到的结果一致</p>

<h3 id="准备工作-1">准备工作</h3>

<p>确保已经正确安装Charles并开启了代理服务，手机和Charles处于同一个局域网下，Charles代理和CharlesCA证书设置好</p>

<h3 id="原理">原理</h3>

<p>首先Charles运行在自己的PC上，Charles运行的时候会在PC的8888端口开启一个代理服务，这个服务实际上是一个HTTP/HTTPS的代理</p>

<p>确保手机和PC在同一个局域网内，我们可以使用手机模拟器通过虚拟网络连接，也可以使用手机真机和PC通过无线网络连接</p>

<p>设置手机代理为Charlse的代理地址，这样手机访问互联网的数据包就会流经Charles，Charles再转发这些数据到真实的服务器，服务器返回的数据包再由Charles转发回手机，Charles就起到中间人的作用，所有流量包都可以捕捉到，因此所有HTTP请求和响应都可以捕获到。同时Charles还有权利对请求和响应进行修改</p>

<p>P398</p>

<h2 id="mitmproxy的使用">mitmproxy的使用</h2>

<p>P405</p>

<h2 id="mitmdump爬取得到app电子书信息">mitmdump爬取“得到”APP电子书信息</h2>

<p>P417</p>

<h2 id="appium的基本使用">Appium的基本使用</h2>

<p>P423</p>

<h2 id="appium爬取微信朋友圈">Appium爬取微信朋友圈</h2>

<p>P433</p>

<h2 id="appiummitmdump爬取京东商品">Appium+mitmdump爬取京东商品</h2>

<p>P437</p>



                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2020/09/15/Python3-%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-1/" data-toggle="tooltip" data-placement="top" title="Python爬虫（1）">
                        Previous<br>
                        <span>Python爬虫（1）</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2020/09/15/IC%E5%8D%A1&ID%E5%8D%A1&CPU%E5%8D%A1/" data-toggle="tooltip" data-placement="top" title="IC卡&ID卡&CPU卡">
                        Next<br>
                        <span>IC卡&ID卡&CPU卡</span>
                        </a>
                    </li>
                    
                </ul>
                <hr style="visibility: hidden;">

                

                
            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        
        
        
                <a data-sort="0005" 
                    href="/archive/?tag=%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0"
                    title="学习笔记"
                    rel="13">学习笔记</a>
        
                <a data-sort="0012" 
                    href="/archive/?tag=%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C"
                    title="计算机网络"
                    rel="6">计算机网络</a>
        
                <a data-sort="0012" 
                    href="/archive/?tag=%E8%B0%A2%E5%B8%8C%E4%BB%81"
                    title="谢希仁"
                    rel="6">谢希仁</a>
        
                <a data-sort="0013" 
                    href="/archive/?tag=Python"
                    title="Python"
                    rel="5">Python</a>
        
                <a data-sort="0014" 
                    href="/archive/?tag=tips"
                    title="tips"
                    rel="4">tips</a>
        
                <a data-sort="0015" 
                    href="/archive/?tag=%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0"
                    title="深度学习"
                    rel="3">深度学习</a>
        
                <a data-sort="0015" 
                    href="/archive/?tag=AI"
                    title="AI"
                    rel="3">AI</a>
        
                <a data-sort="0016" 
                    href="/archive/?tag=%E7%88%AC%E8%99%AB"
                    title="爬虫"
                    rel="2">爬虫</a>
        
                <a data-sort="0016" 
                    href="/archive/?tag=%E7%AE%97%E6%B3%95"
                    title="算法"
                    rel="2">算法</a>
    </div>
</section>


                <!-- Friends Blog -->
                
<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href="https://rapiz.me">rapiz</a></li>
  
</ul>

            </div>
        </div>
    </div>
</article>

<!-- add support for mathjax by voleking-->









<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'right',
          // icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  
  
  
  
  <li>
    <a target="_blank" href="https://github.com/yrj-creator">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
</ul>

                <p class="copyright text-muted">
                    Copyright &copy; Yurj Blog 2020
                    <br>
                    Powered by <a href="http://huangxuan.me">Hux Blog</a> |
                    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="100px"
                        height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true">
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Simple Jekyll Search -->
<script src="/js/simple-jekyll-search.min.js"></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->







<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function () {
        var $nav = document.querySelector("nav");
        if ($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->



<!-- Baidu Tongji -->



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog(selector) {

        // interop with multilangual 
        if ('' == 'true') {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->


<!-- Simple Jekyll Search -->
<script>
    // https://stackoverflow.com/questions/1912501/unescape-html-entities-in-javascript
    function htmlDecode(input) {
        var e = document.createElement('textarea');
        e.innerHTML = input;
        // handle case of empty input
        return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }

    SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('search-results'),
        json: '/search.json',
        searchResultTemplate: '<div class="post-preview item"><a href="{url}"><h2 class="post-title">{title}</h2><h3 class="post-subtitle">{subtitle}</h3><hr></a></div>',
        noResultsText: 'No results',
        limit: 50,
        fuzzy: false,
        // a hack to get escaped subtitle unescaped. for some reason, 
        // post.subtitle w/o escape filter nuke entire search.
        templateMiddleware: function (prop, value, template) {
            if (prop === 'subtitle' || prop === 'title') {
                if (value.indexOf("code")) {
                    return htmlDecode(value);
                } else {
                    return value;
                }
            }
        }
    });

    $(document).ready(function () {
        var $searchPage = $('.search-page');
        var $searchOpen = $('.search-icon');
        var $searchClose = $('.search-icon-close');
        var $searchInput = $('#search-input');
        var $body = $('body');

        $searchOpen.on('click', function (e) {
            e.preventDefault();
            $searchPage.toggleClass('search-active');
            var prevClasses = $body.attr('class') || '';
            setTimeout(function () {
                $body.addClass('no-scroll');
            }, 400)

            if ($searchPage.hasClass('search-active')) {
                $searchClose.on('click', function (e) {
                    e.preventDefault();
                    $searchPage.removeClass('search-active');
                    $body.attr('class', prevClasses);  // from closure 
                });
                $searchInput.focus();
            }
        });
    });
</script>


<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
