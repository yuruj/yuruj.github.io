---
layout: post
title: "深入理解计算机系统 第一章"
author: "yurj"
catelog: true
header-style: text
tags:
  - 计算机系统
  - 学习笔记
---

# 第一章 计算机系统漫游

## 信息就是位+上下文

<img src="/Users/yurunjie/Library/Application Support/typora-user-images/截屏2020-07-20 下午7.01.33.png" alt="截屏2020-07-20 下午7.01.33" style="zoom:50%;" />

作为程序员，我们需要了解数字的机器表示方法，他们是对真值的有限近似值，有时候会有意想不到的行为表现

> ## C编程语言的起源
>
> C语言是系统级编程的首选，同时它也非常适用于应用级程序的编写。同时，C语言还缺乏对非常有用的抽象的显式支持，例如类、对象和异常。像C++和Java这样针对应用级程序的新程序语言解决了这些问题
>
> * C语言与Unix操作系统关系密切
>
> * C语言小而简单
>
> * C语言是为实践目的设计的

## 程序被其他程序翻译成不同的格式

在Unix系统上，从源文件到目标文件的转化是由编译器驱动程序完成的

```shell
linux> gcc -o hello hello.c
```

翻译成可执行文件

<img src="/Users/yurunjie/Library/Application Support/typora-user-images/截屏2020-07-20 下午7.40.03.png" alt="截屏2020-07-20 下午7.40.03" style="zoom:50%;" />

* 预处理阶段。预处理器（cpp）根据以字符#开头的命令，修改原始的C程序

* 编译阶段。编译器（ccl）将文本文件hello.i翻译成hello.s，它包含一个汇编语言程序。该程序包含函数main的定义，如下所示：

  1 main：

  2	subq	$8, %rsp

  3	movl	$.LC0, %edi

  4	call	puts

  5	movl	$0, %eax

  6	addq	$8, %rsp

  7	ret

  定义中2～7行的每条语句都以一种文本格式描述了一条低级机器语言指令。汇编语言是非常有用的，因为他为不同高级语言的不同编译器提供了通用的输出语言

* 汇编阶段。汇编器将hello.s翻译成机器语言指令，把这些指令打包成一种可重定位目标程序的格式，并将结果保存在目标文件hello.o中。hello.c文件是一个二进制文件，它包含的17个字节是函数main的指令编码。如果我们在文本编辑器中打开了hello.o文件，将看到一堆乱码

* 链接阶段。printf函数存在于一个名为printf.o的单独的预编译好了的目标文件中，而这个文件必须以某种方式合并到我们的hello.o程序中。链接器就负责处理这种合并。结果就得到hello文件。它是一个可执行目标文件，可以被加载到内存中，由系统执行

> ## GNU项目
>
> free software

## 了解编译系统如何工作是大有益处的

* 优化程序性能
* 理解链接时出现的错误
* 避免安全漏洞。多年来，缓冲区溢出错误是造成大多数网络和Internet服务器上安全漏洞的主要原因

## 处理器读并解释储存在内存中的指令

```shell
linux> ./hello
```

shell是一个命令行解释器，如果该命令行的第一个单词不是内置的shell命令，那么shell就会假设这是一个可执行文件的名字，它将加载并运行这个文件。所以在此例中，shell将加载并运行hello程序，然后等待程序终止

### 系统的硬件组成

<img src="/Users/yurunjie/Library/Application Support/typora-user-images/截屏2020-07-22 下午1.46.26.png" alt="截屏2020-07-22 下午1.46.26" style="zoom:50%;" />

1、总线

贯穿整个系统的是一组电子管道，它携带信息字节并负责在各个部件间传递。通常总线被设计成传送定长的字节块，也就是字（word）。字中的字节数是一个基本的系统参数。现在的大多数机器字长要么是4个字节，要么是8个字节

2、I/O设备

每个I/O设备都通过一个控制器或适配器与I/O总线相连。控制器和适配器之间的区别主要在于他们的封装方式。控制器是I/O设备本身或者系统的主印制电路板（通常称作主板）上的芯片组。而适配器则是一块插在主板插槽上的卡。无论如何，他们的功能都是在I/O设备和I/O总线之间传递信息

3、主存

主存是一个临时存储设备，在处理执行程序时，用来存放程序和程序处理的数据。从物理上来说，主存是由一组动态随机存取存储器（DRAM）芯片组成的。从逻辑上来说，存储器是一个线性的字节数组，每个字节都有其唯一的地址（数组索引），这些地址是从零开始的。一般来说，组成程序的每条机器指令都由不同数量的字节构成。与C程序变量相对应的数据项的大小是根据类型变化的

4、处理器

中央处理单元（CPU），简称处理器，是解释（或执行）存储在主存中指令的引擎。处理器的核心是一个大小为一个字的存储设备（或寄存器），称为程序计数器（PC）。在任何时刻，PC都指向主存中的某条机器语言指令（即含有该条指令的地址）

从系统通电到断电，处理器一直在不断地执行程序计数器指向的指令，再更新程序计数器，使其指向下一条指令。处理器看上去是按照一个非常简单的指令执行模型来操作的，这个模型是由指令集架构决定的。在这个模型中，指令按照严格的顺序执行，而执行一条指令包含一系列的步骤。处理器从程序计数器指向的内存处读取指令，解释指令中的位，执行该指令指示的简单操作，然后更新PC，使其指向下一条指令，而这条指令并不一定和在内存中刚刚执行的指令相邻

这样的简单操作并不多，他们围绕着主存、寄存器文件和算术/逻辑单元（ALU）进行。寄存器文件是一个小的存储设备，由一些单个字长的寄存器组成，每个寄存器都有唯一的名字。ALU计算新的数据和地址值

	* 加载：从主存复制一个字节或者一个字到寄存器，以覆盖寄存器原来的内容
	* 存储：从寄存器复制一个字节或者一个字到主存的某个位置，以覆盖着这个位置上原来的内容
	* 操作：把两个寄存器的内容复制到ALU，ALU对这两个字做算术运算，并将结果存放到一个寄存器中，以覆盖该寄存器中原来的内容
	* 跳转：从指令本身中抽取一个字，并将这个字复制到程序计数器PC中，以覆盖PC中原来的值

处理器看上去是他的指令集架构的简单实现，但实际上现代处理器使用了非常复杂的机制来加速程序的执行。因此，我们将处理器的指令集架构和处理器的微体系结构区分开来：指令集架构描述的是每条机器代码指令的效果；而微体系结构描述的是处理器实际上是如何实现的

### 运行hello程序

初始时，shell程序执行他的指令，等待我们输入一个命令。当我们在键盘上输入字符串后，shell程序将字符逐一读入寄存器，再把它存放到内存中

<img src="/Users/yurunjie/Library/Application Support/typora-user-images/截屏2020-07-22 下午2.24.16.png" alt="截屏2020-07-22 下午2.24.16" style="zoom:50%;" />

shell执行一系列指令来加载可执行的hello文件，这些指令将hello目标文件中的代码和数据从磁盘复制到主存中

利用直接存储器存取技术，数据可以不通过处理器而直接从磁盘到达主存

<img src="/Users/yurunjie/Library/Application Support/typora-user-images/截屏2020-07-22 下午2.24.34.png" alt="截屏2020-07-22 下午2.24.34" style="zoom:50%;" />

一旦目标文件hello中的代码和数据被加载到主存，处理器就开始执行hello程序的main程序中的机器语言指令。这些指令将"hello, world\n"字符串中的字节从主存复制到寄存器文件中，再从寄存器文件中复制到显示设备，最终显示在屏幕上

<img src="/Users/yurunjie/Library/Application Support/typora-user-images/截屏2020-07-22 下午2.25.00.png" alt="截屏2020-07-22 下午2.25.00" style="zoom:50%;" />

## 高速缓存至关重要

系统花费了大量的时间把信息从一个地方挪到另一个地方。复制就是开销，减慢了程序真正的工作

根据机械原理，较大的存储设备要比较小的存储设备运行的慢，而快速设备的造价远高于同类的低速设备

随着这些年半导体技术的发展，这种处理器与主存之间的差距还在持续增大。加快处理器的运行速度比加快主存的运行速度要容易和便宜的多

针对这种处理器和主存之间的差异，系统设计者采用了更小更快的存储设备，称为高速缓存存储器，作为暂时的集结区域，存放处理器近期可能会需要的信息

L1和L2高速缓存是用一种叫做静态随机访问存储器（SRAM）的硬件技术实现的。比较新的，处理能力更强大的系统甚至有三级高速缓存

系系统可以获得一个很大的存储器，同时访问速度也很快，原因是利用了高速缓存的局部性远离，及程序具有访问局部区域里的数据和代码的趋势。通过让高速缓存里存放可能经常访问的数据，大部分的内存操作都能在快速的高速缓存中完成

<img src="/Users/yurunjie/Library/Application Support/typora-user-images/截屏2020-07-22 下午2.40.00.png" alt="截屏2020-07-22 下午2.40.00" style="zoom:50%;" />

## 存储设备形成层次结构

在处理器和一个较大较慢的设备（例如主存）之间插入一个更小更快的存储设备（例如高速缓存）的想法已经成为了一个普遍的观念

<img src="/Users/yurunjie/Library/Application Support/typora-user-images/截屏2020-07-22 下午2.41.32.png" alt="截屏2020-07-22 下午2.41.32" style="zoom:50%;" />

存储器层次结构的主要思想是上一层的存储器作为低一层存储器的高速缓存

## 操作系统管理硬件

所有应用程序对硬件的操作尝试都必须通过操作系统

操作系统有两个基本功能：（1）防止硬件被失控的应用程序滥用（2）向应用程序提供简单一致的机制来控制复杂而又通常大不相同的低级硬件设备。操作系统通过几个基本的抽象概念（进程、虚拟内存和文件）来实现这两个功能

<img src="/Users/yurunjie/Library/Application Support/typora-user-images/截屏2020-07-22 下午2.46.48.png" alt="截屏2020-07-22 下午2.46.48" style="zoom:50%;" />

### 进程

操作系统会提供一种假象，就好像系统上只有这个程序在运行。程序看上去是独占地使用处理器、主存和I/O设备。处理器看上去就像在不断的一条接一条地执行程序中的指令，及该程序的代码和数据是系统内存中唯一的对象。这些假象是通过进程的概念来实现的，进程是计算机科学中最重要和最成功的概念之一

进程是操作系统对一个正在运行的程序的一种抽象。在一个系统上可以同时运行多个进程，而每个进程都好像在独占地使用硬件。而并发运行，则是说一个进程的指令和另一个进程的指令是交错执行的

操作系统实现这种交错执行的机制称为上下文切换

操作系统保持跟踪进程运行所需的所有状态信息。这种状态，也就是上下文，包括许多信息，比如PC和寄存器文件的当前值，以及主存的内容。在任何一个时刻，但处理器系统都只能执行一个进程的代码。当操作系统决定要把控制权从当前进程转移到某个新进程时，就会进行上下文切换，即保存当前进程的上下文，恢复新进程的上下文，然后将控制权传递到新进程。新进程就会从他上次停止的地方开始

<img src="/Users/yurunjie/Library/Application Support/typora-user-images/截屏2020-07-22 下午3.14.21.png" alt="截屏2020-07-22 下午3.14.21" style="zoom:50%;" />

从一个进程到另一个进程的转换是由操作系统内核Kernel管理的。内核是操作系统代码常驻主存的部分。当应用程序需要操作系统的某些操作时，比如读写文件，他就执行一条特殊的系统调用指令，将控制权传递给内核，然后内核执行被请求的操作并返回应用程序。注意，内核不是一独立的进程。相反，他是系统管理全部进程所用代码和数据结构的集合

<img src="/Users/yurunjie/Library/Application Support/typora-user-images/截屏2020-07-22 下午3.14.05.png" alt="截屏2020-07-22 下午3.14.05" style="zoom:50%;" />

实现进程这个抽象概念需要低级硬件和操作系统软件之间的紧密合作

### 线程

尽管通常我们认为一个进程只有单一的控制流，但是在现代系统中，一个进程实际上可以有多个称为线程的执行单元组成，每个线程都运行在进程的上下文中，并共享代码和全局数据。由于网路服务器中对并行处理的需求，线程成为原来越重要的编程模型，因为多线程之间比多进程之间更容易共享数据，也因为线程一般来说都比进程更高效。当有多处理器可用的时候，多线程也是一种使得程序可以运行得更快的方法

### 虚拟内存

虚拟内存是一个抽象概念，他为每个进程提供了一个假象，即每个进程都在独占地使用内存。每个进程看到的内存都是一致的，称为虚拟地址空间

在Linux中，地址空间最上面的区域是保留给操作系统中的代码和数据的，这对所有进程来说都是一样的。地址空间的底部区域存放用户进程定义的代码和数据

<img src="/Users/yurunjie/Library/Application Support/typora-user-images/截屏2020-07-22 下午3.19.41.png" alt="截屏2020-07-22 下午3.19.41" style="zoom:50%;" />

* 程序代码和数据。对所有的进程来说，代码是从同一固定地址开始，紧接着的是和C全局变量相对应的数据位置。代码和数据区是直接按照可执行目标文件的内容初始化的
* 堆。代码和数据区后紧随着的是运行时堆。代码和数据区在进程已开始运行时就被指定了大小，与此不同，当调用想malloc和free这样的C标准库函数时，堆可以在运行时动态的扩展和收缩
* 共享库。大约在地址空间的中间部分是一块用来存放像C标准库和数学库这样的共享库的代码和数据的区域。共享库的概念非常强大，也相当难懂
* 栈。位于用户虚拟地址空间顶部的是用户栈，编译器用它来实现函数调用。和堆一样，用户栈在程序执行期间可以动态的扩展和收缩。特别的，每次我们调用一个函数时，栈就会增长；从一个函数返回时，栈就会收缩
* 内核虚拟内存。地址空间顶部的区域是为内核保留的。不允许应用程序读写这个区域的内容或直接调用内核代码定义的函数。相反，他们必须调用内核来执行这些操作

虚拟内存的运作需要硬件和操作系用之间精密复杂的交互，包括对处理器生成的每个地址的硬件翻译。基本思想是把一个进程虚拟内存的内容存储在磁盘上，然后用主存作为磁盘的高速缓存

### 文件

文件就是文字序列，仅此而已。每个I/O设备，包括磁盘、键盘、显示器，甚至网络，都可以看成是文件。系统中的所有输入输出都是通过使用一小组称为Unix I/O的系统函数调用读写文件来实现的

文件这个简单而精致的概念是非常强大的，因为他向应用程序提供了一个统一的视图，来看待系统中可能含有的所有各式各样的I/O设备。例如，处理磁盘文件内容的应用程序猿可以非常幸福，因为他么无需了解具体的磁盘技术。进一步说，同一个程序可以在使用不同磁盘技术的不同系统上运行

## 系统之间利用网络通信

从一个单独的系统来看，网络可视为一个I/O设备

<img src="/Users/yurunjie/Library/Application Support/typora-user-images/截屏2020-07-22 下午4.14.02.png" alt="截屏2020-07-22 下午4.14.02" style="zoom:50%;" />

<img src="/Users/yurunjie/Library/Application Support/typora-user-images/截屏2020-07-22 下午4.15.29.png" alt="截屏2020-07-22 下午4.15.29" style="zoom:50%;" />

## 重要主题

### Amdahl定律

想要显著加速整个系统，必须提升全系统中相当大的部分的速度

### 并发和并行

我们用的术语并发是一个通用的概念，指一个同时具有多个活动的系统；而术语并行指的是用并发来使一个系统运行的更快。并行可以在计算机系统的多个抽象层次上运用。在此，我们按照系统层次结构中由高到低的顺序重点强调三个层次

1、线程级并发

使用线程，我们甚至能够在一个进程中执行多个控制流

<img src="/Users/yurunjie/Library/Application Support/typora-user-images/截屏2020-07-22 下午4.24.31.png" alt="截屏2020-07-22 下午4.24.31" style="zoom:50%;" />

<img src="/Users/yurunjie/Library/Application Support/typora-user-images/截屏2020-07-22 下午4.25.40.png" alt="截屏2020-07-22 下午4.25.40" style="zoom:50%;" />

超线程，有时称为同时多线程，是一项允许一个CPU执行多个控制流的技术。他设计CPU某些硬件有多个备份，比如程序计数器和寄存器文件，而其他的硬件部分只有一份，比如执行浮点算数运算的单元。

常规的处理器需要大约2000个时钟周期做不同线程间的转换，而超线程的处理器可以在单个周期的基础上决定要执行哪个线程。这使得CPU能够更好地利用他的处理资源。比如，假设一个线程必须等到某些数据被装载到高速缓存中，那CPU就可以继续去执行另一个线程

多处理器的使用可以从两方面提高系统性能。首先，他减少了在执行多个任务时模拟并发的需要。正如前面提到的，即使是只有一个用户使用的个人计算机也需要并发的执行多个活动。其次，它可以是应用程序运行的更快，当然，这必须要求程序是以多线程的方式来书写的，这些线程可以并行的高效执行

2、指令集并行

在较低的抽象层次上，现代处理器可以同时执行多条指令的属性称为指令集并行

其实每条指令从开始到结束需要长的多的时间，大约20个或者更多周期，但是处理器使用了非常多的聪明技巧来同时处理多达100条指令。流水线的一个相当简单的硬件设计，能够接近于一个时钟周期一条指令的执行速率

如果处理器可以达到比一个周期一条指令更快的执行速率，就称之为超标量处理器。大多数现代处理器都支持超标量操作。应用程序猿可以用超标量处理器的高级模型。应用程序猿可以用这个模型来理解程序的性能。然后，他们就能写出拥有更高程度的指令级并行性的程序代码，因而运行的更快

3、单指令、多数据并行

在最低层次上，许多现代处理器拥有特殊的硬件，允许一条指令产生多个可以并行执行的操作，这种方式称为单指令、多数据，即SIMD并行

### 计算机系统中抽象的重要性

<img src="/Users/yurunjie/Library/Application Support/typora-user-images/截屏2020-07-22 下午4.40.37.png" alt="截屏2020-07-22 下午4.40.37" style="zoom:50%;" />

