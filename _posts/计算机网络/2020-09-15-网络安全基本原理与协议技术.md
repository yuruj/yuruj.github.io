---
layout: post
title: "网络安全基本原理与协议技术（mooc？"
author: "yuruj"
catelog: true
header-style: text
tags:
  - 计算机网络
  - 学习笔记
---

# 网络安全基本原理

## 基础

### 基本属性

- 机密性
- 身份认证
- 信息完整性
- 可访问与可用性

### 研究领域

- 入侵者如何攻击计算机网络 Bad Guys
- 如何防护网络对抗攻击
- 如何设计网络体系机构免疫攻击

### Internet最初设计几乎没考虑安全性

- 各种网络协议的出现
-  网络安全需要在网络各个层次考虑

### 网络安全拟人场景

## 威胁

### Bad Guys——窃听、插入、假冒、劫持、拒绝服务DOS

### Internet安全威胁

- 映射Mapping

    - 发起攻击前：探路，找出网络上在运行什么服务
    - 利用ping命令确定网络上主机的地址
    - 端口扫描：依次尝试与某个端口建立 TCP连接
    - nmap，广为使用的国外端口扫描工具之一
    - 对策

        - 记录到达的网络流量
        - 分析、识别出可疑活动（IP地址和端口被依次扫描）

- 分组嗅探sniffing

    - 广播介质（共享式以太网，无线网络）
    - 混杂模式网路接口可以接受/记录所有经过的分组/帧
    - 可以读到所有未加密数据包括口令
    - Wireshark就是一个典型免费的分组嗅探软件 抓包工具
    - 对策

        - 组织中的所有主机都运行软件，周期性监测网络接口是否运行在混杂模式
        - 每段广播介质连接一台主机（如交换式以太网）没有第三方介入

- IP欺骗

    - 直接由应用生成原始IP分组，可以设置分组的源IP地址为任意值
    - 接收方无法判断源地址是否被欺骗
    - 对策-入口过滤

        - 路由器不转发源IP地址无效的IP分组（e.g.，源IP地址不属于所连接网络）
        - 很有效，但不能强制所有网络都执行入口过滤

- 拒绝服务DOS

    - 向接受方恶意泛洪分组，淹没接收方

        - 带宽耗尽
        - 资源耗尽

    - 分布式拒绝服务攻击DDOS（例如SYN flood-创建TCP连线需要发送SYN同步信息到服务器要求创建连线）

        - 选择目标
        - 入侵网络中主机构建僵尸网络
        - 控制僵尸主机向目标发送分组

    - 反射式DDOS攻击

        - 选择目标
        - 入侵网络中主机
        - 选择反射服务器并利用IP欺骗
        - 借助反射服务器将服务请求返回给目标服务器向目标发起攻击

    - 对策

        - 在到达主机前过滤掉泛洪分组但可能好坏一起丢
        - 追溯traceback攻击源
        - SYN cookie[RFC 4987]

            - y=Hash（源IP地址，目的IP地址，源端口号，目的端口号，R）防止三次握手为攻击分配资源

## 密码学基础

### 术语

- 明文m
- 加密密钥KA
- 密文KA（m）
- 解密密钥m=KB（KA（m））
- 对称密钥加密KA=KB=KS
- 公开密钥加密

    - KB+ Bob的公开密钥 KB- Bob的私有密钥
    - 密文KB+（m）
    - 明文m=KB-（KB+（m））只有Bob能解密

- 破解加密方法

    - 唯密文攻击

        - 暴力破解尝试所有可能的密钥
        - 统计分析

    - 已知明文攻击
    - 选择明文攻击-入侵者可以获取针对选择的明文的密文

### 传统加密方法

- 替代密码

    - 凯撒密码
    - 单码（字母）替代密码-加密密钥：26个字母集合向26个字母集合的映射
    - 多码（字母）替代加密：使用多个单码替代密码，明文中不同位置的字母使用不同的单码替代密码

- 换位密码

    - 置换法

        - 列置换加密

            - 密钥包括列数和输出顺序，可以用一个单词表示
            - 解密可利用转置矩阵

### 现代加密技术

- 基本操作仍为经典的替代和置换——针对二进制位操作
- 对称密钥加密

    - 流密码

        - 首先利用密钥K用伪随机字节产生器（密钥流产生器）产生一个密钥流：z=z0z1z2...
        - 明文串x=x0x1x2...加密：y=y0y1y2...=Ez0(x0)...

    - 分组密码，也称块密码

        - 将明文序列划分成长为m的明文组
        - 各明文组在长为i的密钥组的控制下变换成长度为n的密文组
        - 通常取n=m

            - n>m 拓展分组密码
            - n<m 压缩分组密码

        - 典型分组密码结构：Feistel分组密码结构-破坏对密码系统进行各种统计分析攻击的两个基本操作扩散和混淆

            - 基于扩散和混淆的思考，Feistel提出通过替代和置换交替操作方式构造密码
            - Feistel是一种设计原则，并非一个特殊的密码
            - 加密

                - 将明文分成左右两部分
                - 每一轮i=1，2，...，n计算

                    - Li=Ri-1
                    - Ri=Li-1环和F（Ri-1，Ki）
                    - 其中F是轮函数；Ki-1是子密钥

                - 密文=（Ln，Rn）

            - 解密

                - 密文=（Ln，Rn）
                - 每一轮i=n，n-1，...，1计算

                    - Ri-1=Li
                    - Li-1=Ri环和F（Ri-1，Ki）
                    - 其中F是轮函数；Ki是子密钥

                - 密文=（L0，R0）

            - 安全性取决于

                - 分组长度

                    - 分组长度越大，安全性越高，加密速度越慢，效率越低
                    - 目前常用的分组加密算法的分组长度取64位

                - 子密钥的大小

                    - 子密钥长度增加，安全性提高，加密速度降低
                    - 设计分组密码时需要在安全性和加密效率之间进行平衡

                - 循环次数
                - 子密钥产生算法

                    - 在初始密钥给定的情况下，产生子密钥的算法越复杂，安全性越高

                - 轮函数

        - 数据加密标准：DES

            - 16轮的Feistel结构密码
            - 包含16个阶段的替代-置换的分组加密算法

                - 64位的分组明文序列作为加密算法的输入，经过16加密得到64位的密文序列

            - 分组长度是64位
            - 56位的密钥
            - 48位的子密钥

                - 每一个子密钥是56位密钥的子集构成-压缩变换

            - 1998年12月以后不在将DES作为数据加密标准
            - 将64位明文分成左右组前需按照IP置换表进行一次IP置换 16轮计算后需进行一次IP-1置换得到密文
            - 需将右半部分32位进行拓展变换变为48位
            - f函数结构

                - 黑盒变换
                - 多个函数/操作（E、异或、S、P）的组合函数
                - 拓展变换也被称为E-盒 确保最终的密文与所有的明文位都有关
                - S-盒替代 48比特输入，32比特输出
                - P-盒置换

            - 初始置换和对应的逆初始置换操作并不会增强DES算法的安全性 主要目的是为了更容易地将明文和密文数据以子节大小放入DES芯片中
            - 每轮子密钥的生成

                - 密钥置换分成两组循环移位压缩置换将56比特初始密钥得到48位子密钥

            - 安全性

                - 56位密钥可能太小
                - 迭代次数可能太小-16次恰巧能抵抗差分分析
                - S盒即替代函数可能有不安全因素
                - DES的一些关键部分不应当保密
                - DES存在弱密钥和半弱密钥
                - 针对DES的攻击方法

                    - 差分分析方法
                    - 线性分析方法
                    - 旁路攻击法

            - DES的改进

                - 密码分组链接

                    - 加密算法的输入是当前明文分组和前一次密文分组的异或
                    - 重复的明文分组不会在密文中暴露出重复关系 

                - DES密钥过短

                    - 多重DES

                        - 3DES使用3个密钥，执行三次DES算法

                            - 加密过程：加密-解密-加密（EDE），即C=Ek3（Dk2（Ek1（M）））
                            - 为避免3DES使用3个密钥进行3阶段加密带来的密钥过长缺点 ，可使K1=K3，112bit密钥
                            - 3DES的第二阶段的解密并没有密码编码学上的 意义，唯一优点是可以使用3DES解密原来的单次DES加密的数据，即K1=K2=K3

        - 高级加密标准AES

            - 不属于Feistel结构
            - 加密、解密相似但不完全对成
            - 支持128/192/256数据块大小
            - 支持128/192/256密钥长度
            - 有较好的数学理论作为基础
            - 结构简单、速度快
            - Rijndael算法特点

                - 分组长度和密钥长度均可变 
                - 循环次数允许在一定范围内根据安全要求进行修正
                - 汇聚了安全、效率、易用、灵活等优点
                - 抗线性攻击和差分攻击的能力大大增强
                - 如果1秒暴力破解DES，则需要149万亿年破解AES

- 非对称密钥加密（公开密钥加密）

    - 需求

        - 公钥加密和私钥解密需要满足：KB-（KB+（m））=m
        - 给定公钥，不可能计算得到私钥

    - RSA算法

        - 前提条件：模运算

            - (a mod n)^d mod n = a^d mod n

        - 预备知识

            - 报文/信息：仅仅是一个比特模式
            - 每个比特模式可以表示为一个唯一的整数
            - 因此，加密一个报文等价于加密一个数

        - 生成公钥/私钥对

            - 1.选择2个大质数p和q
            - 2.计算n=pq，z=（p-1）*（q-1）
            - 3.选择e（满足e<n），使e与z之间没有公因子，即e，z互质
            - 4.选择d使得ed-1刚好可以被z整除
            - 5.公钥：（n，e）；私钥：（n，d）

        - 加密、解密

            - 0.给定公钥和私钥
            - 1.加密报文m（m<n）时，计算 c=m^e mod n
            - 2.解密密文c时，计算m=c^d mod n
            - m=(m^e mod n)^d mod n

        - 理论依据

            - 必须满足：c^d mod n = m 其中c=m^e mod n
            - 可以证明：对于任意x和y，有x^y mod n = x^(y mod z) mod n 其中n=pq，z=（p-1）*（q-1）

        - 另一个重要性质 利用公钥加密利用私钥解密，也可以利用私钥加密用公钥解密
        - 安全性

            - 大数分解和素性检测

                - 即将两个大素数相乘在计算上容易实现，而将该乘积分解的计算量相当大

        - 实际应用

            - RSA的幂运算强度很大
            - DES至少把RSA快100倍
            - 利用公钥加密建立安全连接，然后建立第二个密钥-对称会话密钥，用于加密数据
            - 会话密钥

                - B和A利用RSA交换对称会话密钥Ks
                - 一旦双方确认Ks，则利用会话密钥加密/解密会话数据

## 身份认证

### 协议ap1.0:Alice声明I’m Alice

### 协议ap2.0:Alice在IP分组中声明I'm Alice，IP分组包含Alice的源IP地址

### 协议ap3.0:声明的同时，发送她的秘密口令进行证明

- 嗅探攻击

### 协议ap3.1:加密口令

- 回放攻击playback attack

### 协议ap4.0

- 目标：避免回放攻击
- 一次性随机数：一个生命内只用一次的数R
- 为了证明是真实的Alice，Bob向Alice发送一个随机数R，Alice必须返回利用共享密钥加密的R

### 协议ap5.0

- 利用一次随机数以及公钥加密技术
- 因为已知只有Alice拥有加密R的私钥，KA+（KA-（R））=R
- 安全漏洞：中间人攻击

    - 很难检测：Bob与Alice可以收到彼此发送的所有信息
    - 获取Alice的公钥，并利用自己的私钥和公钥可以实现收到所有信息

## 消息完整性与数字签名

### 报文/消息完整性的目标

- 证明报文确实来自声称的发送方
- 验证报文在传输过程中没有被篡改 
- 预防报文的时间、顺序被篡改
- 预防报文持有期被修改
- 预防抵赖-接受方或发送方否认

### 密码散列函数：H（m）

- 散列算法公开
- H（m）能够快速计算
- 对任意长度报文进行多对一映射，均产生定长输出
- 对于任意报文无法预知其散列值
- 不同报文不能产生相同的散列值
- 单向性：无法根据散列值倒推出报文
- 抗弱碰撞性
- 抗强碰撞性

### 散列函数算法

- MD5:被广泛应用的散列函数（RFC 1321）

    - 通过四个步骤，对任意长度的报文输入，计算输出128位的散列值
    - MD5不是足够安全

- SHA-1:另一个正在使用的散列算法

    - US标准
    - SHA-1要求输入消息长度<2的64次方
    - 散列值为160位
    - 速度慢于MD5，安全性优于MD5

### 报文摘要

- 对报文m应用散列函数H，得到一个固定长度的散列码，称为报文摘要，记为H（m）
- 可以作为报文m的数字指纹

### 报文认证

- 简单方案：报文+报文摘要->拓展报文
- 报文认证码MAC：报文m+认证密钥s+密码散列函数H->拓展报文（m，H（m+s））

### 数字签名

- 目标：解决这些与报文完整性相关的问题

    - 否认：发送方不承认自己发送过某一报文
    - 伪造：接收方自己伪造一份报文，并声称来自发送方
    - 冒充：某个用户冒充另一个用户接受或发送报文
    - 篡改：接收方对收到的信息进行篡改

- 数字签名技术是实现安全电子交易的核心技术之一

    - 可验证性
    - 不可伪造性
    - 不可抵赖性

- 对报文m的简单数字签名

    - 报文加密技术是数字签名的基础
    - Bob利用其私钥对m进行加密，创建签名报文
    - Alice利用Bob的公钥解密报文，并检验来证实报文m是Bob签名的
    - 签名m的一定是Bob的私钥

- 签名报文摘要

    - Bob发送数字签名的报文包括大报文m以及用私钥数字签名加密的报文摘要
    - Alice核实签名以及数字签名报文的完整性

## 密钥分发与公钥证书

### 密钥分发中心KDC

- ap4.0Alice与Bob需要共享对称密钥
- KDC：一个服务器

    - 每个注册用户共享其与KDC的秘密密钥

- Alice和Bob只知道自己与 KDC之间的对称密钥，用于分别与KDC进行秘密通信
- 过程

    - A向KDC发送KA-KDC（A，B）
    - KDC产生R1并返回KA-KDC（R1，KB-KDC（A，R1））
    - A获知R1，并发送KB-KDC（A，R1）至B
    - B获知将使用R1与A通信
    - 至此，R1作为会话密钥，用于共享对称加密

### 认证中心CA

- ap5.0
- 比萨恶作剧

    - T创建邮件订单
    - T利用他的私钥签名
    - T向比萨店发送订单，但声称这是Bob的公钥
    - 比萨店核实签名，然后向Bob递送4个腊肠比萨
    - Bob根本不喜欢腊肠
    - 核心公钥问题，无法确认是否是真的Bob的公钥

- CA实现特定实体E与其公钥的绑定
- 每个E（如人、路由器等）在CA上注册其公钥

    - E向CA提供身份证明
    - CA创建绑定E及其公钥的证书
    - 证书包含由CA签名的E的公钥——CA声明：这是E的公钥

- 当Alice想要Bob的公钥

    - 首先获取Bob的公钥证书（从Bob或者其他地方）
    - 应用CA的公钥、解密证书中签名的公钥，获得Bob的公钥

- 公钥证书主要内容

    - 序列号（唯一发行号）
    - 证书持有者信息，包括算法和密钥值
    - 证书发行信息
    - 有效期
    - 发行者数字签名


# 网络安全协议与技术

## 安全电子邮件

### 电子邮件安全威胁

- 垃圾邮件
- 诈骗邮件
- 邮件炸弹
- 传播网络蠕虫/病毒
- 欺骗、钓鱼式攻击

### 安全需求

- 机密性
- 完整性
- 身份认证性
- 抗抵赖性

### 基本原理

- 邮件具有单向性和非实时性
- A期望向B发送机密邮件m

	- 生成随即对称密钥，Ks
	- 利用Ks加密报文（为了效率）
	- 同时，利用Bob的公钥加密Ks
	- 将Ks（m）和KB+（Ks）发送给B

- A期望提供发送者认证与报文完整性

	- Alice对报文进行数字签名
	- 发送报文（明文和数字签名）

- A期望提供保密、发送者认证与报文完整性

	- 使用三个密钥：她自己的私钥、Bob的公钥、新生成的对称密钥

### 安全电子邮件标准

- PEM标准 Privacy Enhanced Mail

	- 运行依赖PKI（公钥基础设施），如CA

		- 没有被广泛配置

	- 提供四种安全服务

		- 邮件加密
		- 报文完整性
		- 发送方的认证
		- 防发送方否认

- PGP标准 Pretty Good Privacy

	- 事实上标准
	- 可在各种平台免费运行
	- 还可用于普通文件加密及军事目的
	- 所用算法被证实为非常安全

		- 公钥加密算法

			- RSA、DSS、Diffie-Hellman

		- 对称加密算法

			- CAST、3DES、IDEA

		- 散列算法

			- MD5、SHA-1

	- 特点

		- 对邮件内容进行数字签名，保证信件内容不被篡改
		- 使用公钥和对称加密保证邮件内容机密且不可否认
		- 公钥的权威性由收发双方或所信任的 第三方签名认证
		- 实现不需要知道任何保密信道来传递对称的会话密钥

	- 功能框架

		- 发送至Internet前的最后一步是Base64

	- PGP密钥

		- 安装PGP时，软件会为用户生成一个公开密钥对

			- 公钥放置用户网站或某公钥服务器上
			- 私钥则使用用户口令进行保护 

		- PGP公钥认证机制与传统CA差异较大

			- PGP公钥可以通过可信的Web认证
			- 用户可以自己认证任何其信任的公钥/用户名对
			- 用户还可以为其他公钥认证提供担保

		- 防止篡改公钥的方法

			- 直接从B手中得到其公钥
			- 通过电话认证密钥
			- 从双方信任的David那里获得Bob的公钥
			- 通过CA

- S/MIME标准

	- 提供数据保密、完整性和认证等服务
	- 不仅限于邮件使用，可用于任何支持MIME数据的传输机制，如HTTP
	- 增加了新的MIME数据类型
	- 只保护邮件的邮件主体，对头部信息则不进行加密
	- 认证机制依赖于层次结构的CA
	- 证书格式采用X.509规范

## 安全套接字层SSL

### Web安全威胁

- 攻击与破坏事件层出不穷 ，需要安全Web服务

	- Web应用广泛、服务器底层软件复杂，可能隐藏安全漏洞

- Web安全威胁的分类

	- 主动攻击

		- 篡改C/S之间信息或篡改Web站点信息 难防易检

	- 被动攻击

		- 监听数据流获取信息或进行信息量分析 难检易防

- 机密性
- 完整性
- 拒绝服务
- 身份认证

	- 冒充合法用户、伪造数据

- Web服务器的安全威胁

	- Web服务越强大，包含安全漏洞概率就越高
	- HTTP服务可在不同权限下运行

- Web浏览器的安全威胁

	- 活动Web页可能隐藏恶意程序

- 通信信道的安全威胁

	- 监听程序会威胁通信信道中所传输信息的机密性
	- 伪造、篡改、重放会威胁所传输信息的机密性
	- 缺乏身份认证使得冒充他人身份进行中间人攻击
	- 缺乏数字签名使得通信双方能相互攻击
	- 拒绝服务攻击使得通信信道不能保证可用性

### 基于应用层实现Web安全

- 为特定应用定制特定安全服务，将安全服务直接嵌入在应用程序中

### 基于传输层实现Web安全

- SSL或TLS可作为基础协议栈的组成部分，对应用透明

	- SMTP HTTP FTP
	- SSL或TLS
	- TCP
	- IP
	- 也可直接嵌入到浏览器中使用

- 使用SSL或TLS后，传输的应用层数据会被加密

	- 保证通信的安全

- 基于网络层实现Web安全

	- IPSec提供端到端（主机到主机）的安全机制

		- 通用解决方案
		- SMTP HTTP FTP
		- TCP
		- IP/IPSec

	- 各种应用程序均可利用IPSec提供的安全机制

		- 减少了安全漏洞的产生

### SSL：Secure Sockets Layer

- 广泛部署的安全协议

	- 几乎所有浏览器和Web服务器
	- https
	- 每年通过SSL交易额达数十亿美元

- 实现：Netscape
- 变体：TLS（RFC 2246）
- 提供

	- 机密性 confidentiality
	- 完整性 integrity
	- 认证 authentication

- 最初目标

	- Web电子商务交易
	- 加密
	- Web服务器认证
	- 可选的客户认证
	- 方便与新商户的商务活动

- 可用于所有基于TCP的网络应用

	- 安全socket借口

### SSL和TCP/IP

- APPlication
- SSL
- TCP
- IP
- SSL为网络应用提供应用编程接口（API）
- C语言和JAVA语言的SSL库/类可用

### 可以像PGP那样实现某些安全可能

- 但是，需要发送字节流以及交互数据
- 需要一组密钥用于整个连接
- 需要证书交换作为协议的一部分：握手阶段

### 简化的SSL：一个简单的安全信道

- 握手：A和B利用它们的证书、私钥认证（鉴别）彼此，依次交换共享密钥
- 密钥派生：A和B利用共享密钥派生出一组密钥
- 数据传输：待传输数据分割成一系列记录
- 连接关闭

### 简单的SSL：一个简单的握手过程

- MS：主密钥
- EMS：加密的主密钥

### 简化的SSL：密钥派生

- 不同加密操作使用不同密钥会更加安全

	- 例如：报文认证码（MAC）密钥和数据加密密钥

- 4个密钥

	- Kc=用于加密客户向服务器发送数据的密钥
	- Mc=用于客户向服务器发送数据的MAC密钥
	- Ks=用于加密服务器向客户发送数据的密钥
	- Ms=用于服务器向客户发送数据的MAC密钥

- 通过密钥派生函数（KDF）实现密钥派生

	- 主密钥+一些随机数

### 简化的SSL：数据记录

- 为什么不直接加密发送给TCP的字节流

	- MAC放到哪

		- 如果放到最后，则只有全部数据收全才能进行完整性认证

- 方案：将字节流分割成一系列记录

### 简化的SSL：序列号

- 问题：攻击者可以捕获和重放记录或者排序记录
- 解决方案：在MAC中增加序列号

	- MAC=MAC（Mx，sequence||data）
	- 注意：记录中没有序列号域

- 问题：攻击者可以重放所有记录
- 解决方案：利用一次性随机数

### 简化的SSL：控制信息

- 问题：截断攻击

	- 攻击者伪造TCP连接的断连段，恶意断开连接
	- 一方或者双方认为对方已没有数据发送

- 解决方案：记录类型，利用一个类型的记录专门用于断连
- MAC=MAC（Mx，sequence||type||data）

### 简化的SSL不完整

- 每个域多长
- 采用哪种加密算法
- 需要协商

	- 允许客户与服务器支持不同加密算法
	- 允许客户与服务器在数据传输之前共同选择特定的算法

### SSL协议栈

- 介于HTTP与TCP之间的一个可选层

	- 绝大多数应用层协议可直接建立在SSL之上

- SSL不是一个单独的协议，而是两层协议

	- SSL握手协议 SSL更改密码规格协议 SSL警告协议 HTTp
	- SSL记录协议
	- TCP
	- IP

### SSL密码组

- 密码组

	- 公开密钥算法
	- 对称加密算法
	- MAC算法

- SSL支持多个密码组
- 常见的SSL对称密码

	- DES-分组密码
	- 3DES-分组密码
	- RC2-分组密码
	- RC4-流密码

- SSL公开密钥加密

	- RSA

- 协商：客户与服务器商定密码组

	- 客户提供选项
	- 服务器挑选其一

### SSL更改密码规格协议

- 更新当前连接的密钥组
- 位于SSL记录协议之上
- Content Type=20
- 协议只包含一条消息（一个值为1的字节）

### SSL警告协议

- Alert消息

	- 当握手过程或数据加密等出错或发生异常时，为对等实体传递SSL警告或终止当前连接

- 位于SSL记录协议之上
- ContentType=21
- 协议包含两个字节：警告级别、警告代码

### SSL握手协议

- 协商结果是SSL记录协议的基础，ContentType=22
- SSL v3.0的握手过程用到三个协议：握手协议、更改密码规格协议和警告协议
- 目的

	- 服务器认证/鉴别
	- 协商：商定加密算法
	- 建立密钥
	- 客户认证/鉴别（可选）

### SSL记录协议

- 记录协议

	- 描述SSL信息交换过程中的记录格式
	- 所有数据含SSL握手信息都被封装在记录中
	- 一个记录由两部分组成：记录头和数据

### 安全套接字层（SSL）

- SSL握手过程

	- 客户发送其支持的算法列表，以及客户一次随机数
	- 服务器从算法列表中选择算法，并发回给用户：选择+证书+服务器一次随机数
	- 客户验证证书，提取服务器公钥，生成预主密钥，并利用服务器的公钥加密预主密钥，发送给服务器
	- 客户与服务器基于预主密钥和一次随机数分别独立计算加密密钥和MAC密钥
	- 客户发送一个针对所有握手信息的MAC
	- 服务器发送一个针对所有握手新的MAC
	- 最后两步的意义：保护握手过程免遭篡改

		- 客户提供的算法，安全性有强、有弱

			- 明文传输

		- 中间人攻击可以从列表中删除安全性强的算法

	- 为什么使用两个一次随机数

		- 防止嗅探发送相同的记录序列B为每次连接发送完全不同的一次随机数确保两次的加密密钥不同

- SSL握手协议

	- SSL握手消息及参数
	- 握手协议工作过程

- SSL记录协议

	- 操作步骤

		- 将数据分段成可操作的数据块
		- 将分块数据进行数据压缩
		- 计算MAC值
		- 对压缩数据及MAC值加密
		- 加入SSL记录头

			- 内容类型、版本、长度

		- 在TCP中传输

	- MAC

		- 包括序列号，MAC密钥Mx

	- 片段（fragment）

		- 每个SSL片段为2^14字节（～16KB）

- 密钥派生

	- 客户一次数、服务器一次数和预处理器输入伪随机数发生器产生主密钥MS
	- 主密钥和和一次性随机数输入另一个伪随机数发生器：密钥块
	- 密钥块切片

		- 四个密钥
		- 客户初始向量IV
		- 服务器初始向量IV

## IP安全（IPSec）

### 专用网（PN）

- 动机：安全
- 专用网落PN（Private Networks）基于专属的网络设备、链路或协议等建设的专门服务于特定组织机构的网络。
- 成本问题

### 虚拟专用网（VPN）

- 动机：安全+成本
- 通过建立在公共网络上的安全通道，实现远程用户、分支机构、业务伙伴等与机构总部网络的安全连接，从而构建针对特定组织机构的专用网络
- 功能

	- 数据机密性保护
	- 数据完整性认证
	- 数据源身份认证
	- 放重访攻击
	- 访问控制

- 关键技术

	- 隧道技术

		- 构建VPN的核心技术
		- 隧道：通过Internet提供安全的点到点（或端到端）的数据传输安全通道

			- 实质上是一种封装

		- VPN隧道利用隧道协议对通过隧道传输的数据进行封装

			- 使数据安全穿越公共网络
			- 通过加密和认证以确保安全
			- 数据包进入隧道时，由VPN封装成IP数据报
			- 通过隧道在Internet上安全传输
			- 离开隧道后，进行解封装，数据便不再被保护

		- 隧道协议

			- 乘客协议Passenger Protocol
			- 封装协议Encapsulating Protocol 
			- 承载协议Carrier Protocol

		- 常见VPN隧道协议

			- 第二层隧道：PPTP、L2TP

				- 主要用于远程客户机访问局域网方案

			- 第三层隧道：IPSec

				- 主要用于网关到网关、或网关到主机方案
				- 不支持远程拨号访问

		- 典型VPN实现技术

			- IPSec：最安全、适用面最广
			- SSL：具有高层安全协议的优势
			- L2TP：最好的实现远程接入VPN的技术
			- 典型VPN技术结合：IPSec与SSL、IPSec与L2TP

	- 数据加密
	- 身份认证
	- 密钥管理
	- 访问控制
	- 网络管理

### IPSec

- IPSec服务

	- 机密性
	- 数据完成性
	- 源认证/鉴别
	- 重放攻击协议
	- 提供不同服务模型的两个协议：AH、ESP

		- AH：在IP数据报文头中的协议号为51

			- 认证头协议AH提供源认证/鉴别和数据完整性检验，但不提供机密性

		- ESP：在IP数据报文头中的协议号为50

			- 封装安全协议ESP提供源认证/鉴别、数据完整性检验以及机密性
			- 比AH应用更广泛

- IPSec的传输模式

	- IPSec数据报的发送与接收均有端系统完成
	- 主机是IPSec感知的

- IPSec的隧道模式

	- 边缘路由器是IPSec感知的

- IPSec模式与协议的4种组合

	- 其中隧道模式ESP最普遍、最重要

- 安全关联（SA）

	- 发送数据前，从发送是提到接受实体之间需要建立安全关联的

		- SA是单工的：单向

	- 发送实体与接收实体均需要维护SA的状态信息

		- TCP连接的端点也需要维护状态信息
		- IP是无连接的：IPSec是面向连接的

	- 安全关联主要参数

		- 安全参数索引（SPI）

			- 32位SA唯一标识（ID）
			- 加密密钥、认证密钥
			- 密码算法标识
			- 序列号（32位）

				- 抗重放攻击

			- 抗重播窗口

				- 接收方使用滑动窗口检测恶意主机重放数据报

			- 生存周期

				- 规定SA的有效使用周期

			- 运行模式：传输模式或隧道模式
			- IPSec隧道源、目的地址

	- 安全数据库（SAD）

		- IPSec端点将SA状态保存在安全关联数据库SAD中

			- 在处理IPSec数据包时，定位这些信息

		- 对于n个销售人员，一条分支机构的VPN，总部的路由器R1的SAD中存储2+2n条SAs
		- 当发送IPSec安全报时，R1访问SAD，确定如何处理数据报
		- 当IPSec数据报到达R2

			- R2检验IPSec数据包中的SPI
			- 利用SPI检索SAD
			- 处理数据报

	- 安全策略数据库（SPD）

		- 定义了对什么样的数据流实施什么样的安全处理

			- 应用IPSec、绕过、丢弃

		- 安全策略组成了SPD，每个记录就是一条SP

			- 提取关键信息填充到一个称为选择符的结构

				- 包括目标IP、源IP、传输层协议、源和目标端口等

			- 利用选择符去搜索SPD检索匹配的SP

		- 安全处理需要的参数存储在SP指向的SA结构

- IPSec数据包

	- 传输模式AH
	- 隧道模式AH
	- 传输模式ESP
	- 隧道模式ESP

- IPsec序列号

	- 对于新SA，发送方初始化序列号为0
	- 每次通过SA发送数据报将序列号+1
	- 目的

		- 预防嗅探与回放分组攻击
		- 接收重复的、已认证的IP分组，会破坏正常服务

	- 方法

		- 接收方检验分组重复
		- 无需记录所有已接收分组；而是利用一个窗口

- SA的建立和密钥管理

	- IPSec支持两种方式的SA建立和密钥管理

		- 手工方式

			- 所有信息需要手工配置
			- SA永远存在
			- 适用于结构简单的网络

		- 自动方式

			- SA可以通过协商方式产生
			- SA过期以后重新协商，提高了安全性
			- 适用于较复杂结构和较高安全性的网络

	- IKE用于交换算法、秘密密钥、SPI

- IPSec对等端可以是：两个端系统、两个路由器/防火墙、一个路由器/防火墙与一个端系统

## 无线局域网安全

### WEP的设计目标

- WEP：有线等效保密
- 对称密钥加密
- 自同步：每个分组单独加密

	- 给定加密分组和密钥，便可以解密；即便前序分组丢失，也可以通过成功解密分组（与CBC不同）

- 高效

	- 可以由硬件或软件实现

### 流密码与分组独立性

- 如果对于n+1号帧使用的密钥流，是在n号帧的密钥流之后，那么每个帧就不是独立加密的

	- 需要知道n号帧使用的密钥流截止到哪里

- WEP的解决方案：初始密钥+针对每个分组的新IV（初始向量），产生针对每个分组的密钥流

### WEP加密

### 破解802.11WEP加密

- 安全漏洞

	- 每帧一个24位的IV->IV最终会被重用
	- IV以明文传输->重用IV容易被监测

- 攻击

### 802.11i：改进的安全

### EAP：拓展认证协议

## 防火墙

### 隔离组织内部网络与公共互联网，允许某些分组通过，而组织其他分组进入/离开内部网络的软件/硬件设施

### 预防拒绝服务攻击DoS

- SYN泛洪：攻击者建立许多虚假TCP连接、耗尽资源，导致真正的连接无法建立

### 预防非法修改/内部数据访问

### 只允许对内部网络的授权访问

### 三种类型的防火墙

- 无状态分组过滤器

	- 内部网络通过路由器防火墙与Internet连接
	- 路由器逐个分组过滤，决策是否转发/丢弃分组依据：

		- 源IP地址、目的IP地址
		- TCP/UDP源、目的端口号
		- ICMP报文类型
		- TCP SYN和ACK标识位

	- 访问控制列表

- 有状态分组过滤器

	- 无状态：笨拙

		- 不加以区分放行满足条件的所有分组

	- 跟踪每个TCP连接

		- 跟踪连接建立（SYN）、拆除（FIN）：根据状态确认是否放行进入或外出的分组
		- 超时的非活动连接：不再允许分组通过

	- 拓展ACL，以便在放行分组前，检测连接状态表

- 应用网关

	- 基于应用数据以及IP/TCP/UDP头部字段过滤分组
	- 例如：允许特定用户telnet外部网络

### 防火墙、应用网关的局限性

- IP欺骗
- 如果多个应用需要特殊处理，则每个应用需要一个应用网关
- 客户软件必须知道如何连接网关

	- 必须配置Web浏览器的代理服务器的IP地址

- 过滤器经常对UDP流量使用全部通过或者全部不通过策略
- 折衷：确定安全级别
- 很多安全防护级别很高的网站仍然遭受攻击

*XMind - Trial Version*
